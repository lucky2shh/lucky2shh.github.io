<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="RocketMQ系列-RocketMQ原理解析, 豪哥博客">
    <meta name="description" content="豪哥个人博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>RocketMQ系列-RocketMQ原理解析 | 豪哥博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">豪哥博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">豪哥博客</div>
        <div class="logo-desc">
            
            豪哥个人博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">RocketMQ系列-RocketMQ原理解析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/RocketMQ/">
                                <span class="chip bg-color">RocketMQ</span>
                            </a>
                        
                            <a href="/tags/RocketMQ%E5%8E%9F%E7%90%86/">
                                <span class="chip bg-color">RocketMQ原理</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/RocketMQ/" class="post-category">
                                RocketMQ
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-08-07
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-08-07
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    6.5k
                </div>
                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1、消息存储"><a href="#1、消息存储" class="headerlink" title="1、消息存储"></a>1、消息存储</h1><p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%8401.png"> </p>
<p>消息存储是RocketMQ中最复杂和最重要的一部分，下面将从 RocketMQ消息存储整体架构、PageCache与Mmap内存映射、RocketMQ中两种不同的刷盘方式等 三方面来展开叙述。</p>
<h2 id="1-1、消息存储架构"><a href="#1-1、消息存储架构" class="headerlink" title="1.1、消息存储架构"></a>1.1、消息存储架构</h2><p>消息存储架构图中 与 消息存储相关的文件有 3个：</p>
<ul>
<li><p><font color='orange'>CommitLog</font></p>
<p><font color='orange'>定义</font>：消息主体、元数据的存储主体。</p>
<p><font color='orange'>工作过程</font>：Producer端写入的消息内容 并非是定长 的。单个文件大小默认1G ，文件名长度为20位，左边补零，剩余为起始偏移量。</p>
<p>比如 00000000000000000000 代表了第一个文件，起始偏移量为0，文件大小为1G&#x3D;1073741824；当第一个文件写满了，第二个文件为00000000001073741824，起始偏移量为1073741824，以此类推。消息主要是顺序写入日志文件，当文件满了，写入下一个文件；</p>
</li>
<li><p><font color='orange'>ConsumeQueue</font></p>
<p><font color='orange'>定义</font>：消息消费队列。是基于topic的commitlog索引文件，故consumequeue文件夹的组织方式如下：topic&#x2F;queue&#x2F;file三层组织结构，具体存储路径为：$HOME&#x2F;store&#x2F;consumequeue&#x2F;{topic}&#x2F;{queueId}&#x2F;{fileName}。</p>
<p><font color='orange'>设计</font>：consumequeue文件采取定长设计，每一个条目共20个字节，分别为8字节的commitlog物理偏移量、4字节的消息长度、8字节tag hashcode，单个文件由30W个条目组成，可以像数组一样随机访问每一个条目，每个ConsumeQueue文件大小约5.72M；</p>
<p><font color='orange'>作用</font>：主要为了提高消息消费的性能。</p>
<p><font color='orange'>工作过程</font>：消息的消费是针对主题进行的，Consumer可根据ConsumeQueue来查找待消费的消息。</p>
<p><font color='orange'>保存内容</font>：ConsumeQueue作为消费消息的索引，保存了指定Topic下的队列消息在CommitLog中的起始物理偏移量offset、消息大小size 和 消息Tag的HashCode值。</p>
</li>
<li><p><font color='orange'>IndexFile</font></p>
<p><font color='orange'>作用</font>：通过 key 或 时间区间 查询消息 的方法。</p>
<p><font color='orange'>文件大小</font>：文件名fileName是以创建时的时间戳命名的。固定的单个IndexFile文件大小约为400M，一个IndexFile可以保存 2000W个索引。</p>
<p><font color='orange'>存储位置c</font>：$HOME \store\index${fileName}。</p>
<p><font color='orange'>底层设计</font>：IndexFile的底层存储设计为在文件系统中实现HashMap结构，故rocketmq的索引文件其底层实现为hash索引。</p>
</li>
</ul>
<p><strong>RocketMQ采用 混合型存储结构，即单个Broker实例下所有的队列共用一个日志数据文件（CommitLog）来存储。</strong></p>
<p>RocketMQ混合型存储结构（多个Topic消息实体内容都存储于一个CommitLog中）针对 Producer 和 Consumer 分别采用了【数据 和 索引 相分离的 存储结构】。Producer发送消息至Broker，然后Broker通过同步或异步方式将消息保存至CommitLog。一旦保存其中，Producer发送的消息就不会丢失。</p>
<p>无法拉取消息 时 可以等下一次消息拉取，同时服务端也支持【长轮询模式】。如果 一个消息拉取请求 未拉取到 消息，Broker允许等待30s时间，只要这段时间内有新消息到达，将直接返回给消费端。RocketMQ具体做法：使用Broker后台服务线程ReputMessageService不停 分发请求 并 异步构建ConsumeQueue（逻辑消费队列）和 IndexFile（索引文件）数据。</p>
<h2 id="1-2、页缓存与内存映射"><a href="#1-2、页缓存与内存映射" class="headerlink" title="1.2、页缓存与内存映射"></a>1.2、页缓存与内存映射</h2><h3 id="1-2-1、页缓存"><a href="#1-2-1、页缓存" class="headerlink" title="1.2.1、页缓存"></a>1.2.1、页缓存</h3><p><strong>页缓存是OS对文件的缓存，用于加速文件读写。</strong></p>
<p>程序 顺序读写速度 接近于 内存读写速度，主要原因是 OS 使用 PageCache机制 优化了 读写。</p>
<ul>
<li><p><font color='orange'>写入数据</font></p>
<p>OS先写入Cache中，后通过 异步方式 由 pdflush内核线程 将 Cache中的数据刷新至物理磁盘。</p>
</li>
<li><p><font color='orange'>读取数据</font></p>
<p>如果一次读取文件 未命中PageChche，那么OS从物理磁盘读取文件时会将相邻数据文件一块读取。</p>
</li>
</ul>
<blockquote>
<p>ConsumeQueue逻辑消费队列存储的数据较少，且是顺序读取，在page cache辅助下其读性能接近于内存，即使是消息堆积也不会影响性能。</p>
<p>对 CommitLog日志数据文件的读取是随机的，严重影响性能。但如果选择合适的系统IO调度算法，那么性能也会有一定的提升。</p>
</blockquote>
<h3 id="1-2-2、内存映射"><a href="#1-2-2、内存映射" class="headerlink" title="1.2.2、内存映射"></a>1.2.2、内存映射</h3><p>RocketMQ主要通过 MappedByteBuffer 对文件进行读写操作。利用了NIO 的 FileChannel模型 将磁盘上的物理文件 直接映射到 用户态内存地址中，将对文件的操作转化为直接对内存地址进行操作，从而极大地提高了文件的读写效率（正因为需要使用内存映射机制，故RocketMQ的文件存储都使用定长结构来存储，方便一次将整个文件映射至内存）。</p>
<h2 id="1-3、消息刷盘"><a href="#1-3、消息刷盘" class="headerlink" title="1.3、消息刷盘"></a>1.3、消息刷盘</h2><p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-%E6%B6%88%E6%81%AF%E5%88%B7%E7%9B%9801.png"></p>
<p>消息刷盘 主要有 两种：</p>
<ul>
<li><p><font color='orange'>同步刷盘</font></p>
<p>消息 成功持久化至 磁盘后 Broker端才会返回成功的ACK响应给Producer端。同步刷盘可有效保证 MQ消息的可靠性，但对性能会有较大影响，一般适用于金融业务。</p>
</li>
<li><p><font color='orange'>异步刷盘</font></p>
<p>能充分利用【OS PageCache】优势，消息写入PageCache后就可返回ACK给Producer端。消息刷盘 采用 后台异步线程 进行，降低了读写延迟，提高了MQ性能和吞吐量。</p>
</li>
</ul>
<h1 id="2、通信机制"><a href="#2、通信机制" class="headerlink" title="2、通信机制"></a>2、通信机制</h1><h2 id="2-1、简介"><a href="#2-1、简介" class="headerlink" title="2.1、简介"></a>2.1、简介</h2><p><strong>RocketMQ集群 主要包括 NameServer、Broker(Master&#x2F;Slave)、Producer、Consumer4个角色，</strong>基本通讯流程如下：</p>
<ol>
<li>Broker启动后需将自己【注册】至NameServer；随后每隔30s定时向NameServer【上报】Topic路由信息。</li>
<li>Producer发送消息时 需要根据 消息的Topic 从本地缓存TopicPublishInfoTable中获取路由信息。如果没有则更新路由信息并从NameServer上重新拉取，同时Producer会默认每隔30s向NameServer拉取一次路由信息。</li>
<li>Producer 根据 第2步中获取的路由信息 选择 一个队列 来发送消息；Broker 接收消息 并 落盘存储。</li>
<li>Consumer 根据 第2步中获取的路由信息，并在完成客户端负载均衡后，选择其中的某一个或某几个消息队列来拉取消息并消费。</li>
</ol>
<p>从 第1步~第3步 中可以看出 消息在生产者、Broker和NameServer之间都会发生通信。</p>
<p>rocketmq-remoting 负责网络通信。为了实现客户端与服务器之间的高效通信，自定义了通信协议并在Netty基础上扩展了通信模块。</p>
<h2 id="2-2、Remoting通信类结构"><a href="#2-2、Remoting通信类结构" class="headerlink" title="2.2、Remoting通信类结构"></a>2.2、Remoting通信类结构</h2><p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-Remoting%E9%80%9A%E4%BF%A1%E7%B1%BB%E7%BB%93%E6%9E%84.png"></p>
<h2 id="2-3、协议设计与编解码"><a href="#2-3、协议设计与编解码" class="headerlink" title="2.3、协议设计与编解码"></a>2.3、协议设计与编解码</h2><p><strong>Producer发送消息 需要协议 来约定，故有必要自定义RocketMQ消息协议。为 高效 网络传输消息 和 读取消息，需要对消息进行编解码。</strong>类RemotingCommand在消息传输过程中会对所有数据内容进行封装，不但包含了所有的数据结构，还包含了编码解码操作。</p>
<table>
<thead>
<tr>
<th align="center">Header字段</th>
<th align="center">类型</th>
<th align="center">Request说明</th>
<th align="center">Response说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">code</td>
<td align="center">int</td>
<td align="center">请求操作码，应答方根据不同的请求码进行不同的业务处理</td>
<td align="center">应答响应码。0表示成功，非0则表示各种错误</td>
</tr>
<tr>
<td align="center">language</td>
<td align="center">LanguageCode</td>
<td align="center">请求方实现的语言</td>
<td align="center">应答方实现的语言</td>
</tr>
<tr>
<td align="center">version</td>
<td align="center">int</td>
<td align="center">请求方程序的版本</td>
<td align="center">应答方程序的版本</td>
</tr>
<tr>
<td align="center">opaque</td>
<td align="center">int</td>
<td align="center">相当于requestId，在同一个连接上的不同请求标识码，与响应消息中的相对应</td>
<td align="center">应答不做修改直接返回</td>
</tr>
<tr>
<td align="center">flag</td>
<td align="center">int</td>
<td align="center">区分是普通RPC还是onewayRPC的标志</td>
<td align="center">区分是普通RPC还是onewayRPC的标志</td>
</tr>
<tr>
<td align="center">remark</td>
<td align="center">String</td>
<td align="center">传输自定义文本信息</td>
<td align="center">传输自定义文本信息</td>
</tr>
<tr>
<td align="center">extFields</td>
<td align="center">HashMap&lt;String, String&gt;</td>
<td align="center">请求自定义扩展信息</td>
<td align="center">响应自定义扩展信息</td>
</tr>
</tbody></table>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-image-20210819150130564.png"></p>
<p>传输内容主要可分为以下4部分：</p>
<ul>
<li><font color='orange'>消息长度</font>：总长度，四个字节存储，占用一个int类型；</li>
<li><font color='orange'>序列化类型&amp;消息头长度</font>：同样占用一个int类型，第一个字节表示序列化类型，后面三个字节表示消息头长度；</li>
<li><font color='orange'>消息头数据</font>：经过序列化后的消息头数据；</li>
<li><font color='orange'>消息主体数据</font>：消息主体的二进制字节数据内容；</li>
</ul>
<h2 id="2-4、消息的通信方式和流程"><a href="#2-4、消息的通信方式和流程" class="headerlink" title="2.4、消息的通信方式和流程"></a>2.4、消息的通信方式和流程</h2><p><strong>RocketMQ通信方式主要有 同步(sync)、异步(async)、单向(oneway) 三种。</strong>其中“单向”通信模式相对简单，一般用在 发送心跳包 场景下，无需关注其Response。这里，主要介绍异步通信流程。</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6-%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E5%92%8C%E6%B5%81%E7%A8%8B.png"></p>
<h2 id="2-5、Reactor多线程设计"><a href="#2-5、Reactor多线程设计" class="headerlink" title="2.5、Reactor多线程设计"></a>2.5、Reactor多线程设计</h2><p><strong>RocketMQ 基于Netty实现 RPC通信，遵循 Reactor多线程模型 同时又做了 扩展和优化。</strong></p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6-Reactor%E5%A4%9A%E7%BA%BF%E7%A8%8B.png"></p>
<p>根据上图所示，整个执行流程可描述如下：</p>
<ol>
<li>eventLoopGroupBoss负责监听 TCP网络连接请求，建立好连接，创建SocketChannel，并注册到selector上。</li>
<li>RocketMQ会根据OS类型自动选择NIO和Epoll。</li>
<li>监听真正的网络数据，拿到网络数据后丢给Worker线程池。</li>
<li>在执行业务逻辑前需要通过defaultEventExecutorGroup进行SSL验证、编解码、空闲检查、网络连接管理等操作。</li>
<li>根据 RomotingCommand 的业务请求码code 从 processorTable本地缓存变量中找到对应 processor，将其封装成task任务后提交给对应的业务processor处理线程池来执行。</li>
</ol>
<p>从入口到业务逻辑的几个步骤中线程池一直再增加，这跟每一步逻辑复杂性相关，越复杂，需要的并发通道越宽。</p>
<table>
<thead>
<tr>
<th align="center">线程数</th>
<th align="center">线程名</th>
<th align="center">线程具体说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">NettyBoss_%d</td>
<td align="center">Reactor 主线程</td>
</tr>
<tr>
<td align="center">N</td>
<td align="center">NettyServerEPOLLSelector_%d_%d</td>
<td align="center">Reactor 线程池</td>
</tr>
<tr>
<td align="center">M1</td>
<td align="center">NettyServerCodecThread_%d</td>
<td align="center">Worker线程池</td>
</tr>
<tr>
<td align="center">M2</td>
<td align="center">RemotingExecutorThread_%d</td>
<td align="center">业务processor处理线程池</td>
</tr>
</tbody></table>
<h1 id="3、消息过滤"><a href="#3、消息过滤" class="headerlink" title="3、消息过滤"></a>3、消息过滤</h1><p><strong>RocketMQ消息过滤方式是在Consumer端订阅消息时再做消息过滤，原因是 Producer端写入消息和Consumer端订阅消息采用 分离存储机制 实现。</strong>Consumer端订阅消息需要通过ConsumeQueue拿到一个索引，然后再从CommitLog里面读取真正的消息实体内容。</p>
<p>ConsumeQueue存储结构如下：</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-%E6%B6%88%E6%81%AF%E8%BF%87%E6%BB%A401.png"></p>
<p>RocketMQ主要支持如下2种消息过滤方式：</p>
<ul>
<li><p><font color='orange'>Tag过滤</font></p>
<p><font color='orange'>Consumer端订阅消息时 既可指定Topic 也可指定TAG，如果一个消息有多个TAG，可以用 || 分隔。</font></p>
<p>Consumer端会将订阅请求构建成一个 SubscriptionData，发送一个Pull消息请求给Broker端。Broker端从RocketMQ的文件存储层—Store读取数据之前，会用这些数据先构建一个MessageFilter，然后传给Store。Store从 ConsumeQueue读取到一条记录后，会用它记录的消息tag hash值去做过滤，由于在服务端只是根据hashcode进行判断，无法精确对tag原始字符串进行过滤，故在消息消费端拉取到消息后，还需要对消息的原始tag字符串进行比对，如果不同，则丢弃该消息，不进行消息消费。</p>
</li>
<li><p><font color='orange'>SQL92过滤</font></p>
<p>大致与 Tag过滤方式 一样，只是在Store层的具体过滤过程有区别。rocketmq-filter模块负责 SQL expression 构建和执行。每次过滤都执行SQL表达式会影响效率，所以RocketMQ使用了BloomFilter避免了每次都去执行。SQL92表达式上下文 为 消息属性。</p>
</li>
</ul>
<h1 id="4、负载均衡"><a href="#4、负载均衡" class="headerlink" title="4、负载均衡"></a>4、负载均衡</h1><p><strong>RocketMQ中的负载均衡都在Client端完成，主要分为 Producer端发送消息负载均衡 和 Consumer端订阅消息负载均衡。</strong></p>
<h2 id="4-1、Producer负载均衡"><a href="#4-1、Producer负载均衡" class="headerlink" title="4.1、Producer负载均衡"></a>4.1、Producer负载均衡</h2><p>Producer端 发送消息时 会根据Topic找到对应TopicPublishInfo，然后客户端selectOneMessageQueue()方法会从TopicPublishInfo中的messageQueueList中选择一个队列来发送消息。</p>
<p>容错策略在MQFaultStrategy类中定义。如果开启sendLatencyFaultEnable，那么在随机递增取模的基础上会再过滤掉not available的Broker代理。latencyFaultTolerance是指 对之前失败的会按一定时间做退避。</p>
<p>例如，如果上次请求的latency超过550Lms，就退避3000Lms；超过1000L，就退避60000L；如果关闭，采用随机递增取模的方式选择一个队列来发送消息，latencyFaultTolerance机制是实现 消息发送高可用 的核心。</p>
<h2 id="4-2、Consumer负载均衡"><a href="#4-2、Consumer负载均衡" class="headerlink" title="4.2、Consumer负载均衡"></a>4.2、Consumer负载均衡</h2><p>Consumer两种消费模式（Push&#x2F;Pull）全都基于【<font color='orange'>拉</font>】来获取消息，Push模式是对pull模式的一种封装，其本质实现为消息拉取线程从服务器拉取到一批消息后会提交到消息消费线程池，然后会继续尝试再次从服务器拉取消息。如果未拉取到消息，则延迟一下又继续拉取。</p>
<p>Consumerl两种消费方式的实现的前提是：Consumer知道从Broker端的哪一个消息队列中获取消息。故需要在Consumer端做负载均衡。</p>
<h3 id="4-2-1、Consumer心跳包发送"><a href="#4-2-1、Consumer心跳包发送" class="headerlink" title="4.2.1、Consumer心跳包发送"></a>4.2.1、Consumer心跳包发送</h3><p><strong>Consumer启动后会通过 定时任务 不断向RocketMQ集群中的所有Broker实例发送 心跳包（其中包含了，消息消费分组名称、订阅关系集合、消息通信模式和客户端id的值等信息）。</strong>Broker端收到Consumer心跳消息后会将它维护在ConsumerManager的本地缓存变量consumerTable中，同时并将封装后的客户端网络通道信息保存在本地缓存变量—channelInfoTable中，后期为做Consumer端负载均衡提供可以依据的元数据信息。</p>
<h3 id="4-2-2、Consumer实现负载均衡的核心类——RebalanceImpl"><a href="#4-2-2、Consumer实现负载均衡的核心类——RebalanceImpl" class="headerlink" title="4.2.2、Consumer实现负载均衡的核心类——RebalanceImpl"></a>4.2.2、Consumer实现负载均衡的核心类——RebalanceImpl</h3><p><strong>Consumer实例启动流程中的启动MQClientInstance实例部分，会完成负载均衡服务线程RebalanceService的启动（每隔20s执行一次）。</strong>RebalanceService的run()方法最终会调用RebalanceImpl类的rebalanceByTopic()方法，该方法是实现Consumer端负载均衡的核心。<strong>rebalanceByTopic()方法会根据 消费者通信类型 为“广播模式”还是“集群模式”做不同的逻辑处理。</strong>集群模式主要处理流程可描述如下：</p>
<ol>
<li><p>从rebalanceImpl实例的opicSubscribeInfoTable中，获取该Topic主题下的消息消费队列集合（mqSet）；</p>
</li>
<li><p>根据topic和consumerGroup为参数调用mQClientFactory.findConsumerIdList()方法向Broker端发送获取该消费组下消费者Id列表的RPC通信请求（Broker端基于前面Consumer端上报的心跳包数据而构建的consumerTable做出响应返回，业务请求码：GET_CONSUMER_LIST_BY_GROUP）；</p>
</li>
<li><p>先对Topic下的消息消费队列、消费者Id排序，然后用消息队列分配策略算法（默认为：消息队列的平均分配算法），计算出待拉取的消息队列。这里的平均分配算法，类似于分页的算法，将所有MessageQueue排好序类似于记录，将所有消费端Consumer排好序类似页数，并求出每一页需要包含的平均size和每个页面记录的范围range，最后遍历整个range而计算出当前Consumer端应该分配到的记录（这里即为：MessageQueue）。</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-image-20210819184511921.png"></p>
</li>
<li><p>然后，调用updateProcessQueueTableInRebalance()方法，具体的做法是，先将分配到的消息队列集合（mqSet）与processQueueTable做一个过滤比对。</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-image-20210819184609602.png"></p>
<ul>
<li>上图中processQueueTable标注的红色部分，表示与分配到的消息队列集合mqSet互不包含。将这些队列设置Dropped属性为true，然后查看这些队列是否可以移除出processQueueTable缓存变量，这里具体执行removeUnnecessaryMessageQueue()方法，即每隔1s 查看是否可以获取当前消费处理队列的锁，拿到的话返回true。如果等待1s后，仍然拿不到当前消费处理队列的锁则返回false。如果返回true，则从processQueueTable缓存变量中移除对应的Entry；</li>
<li>上图中processQueueTable的绿色部分，表示与分配到的消息队列集合mqSet的交集。判断该ProcessQueue是否已经过期了，在Pull模式的不用管，如果是Push模式的，设置Dropped属性为true，并且调用removeUnnecessaryMessageQueue()方法，像上面一样尝试移除Entry；</li>
</ul>
<p>最后，为过滤后的消息队列集合（mqSet）中的每个MessageQueue创建一个ProcessQueue对象并存入RebalanceImpl的processQueueTable队列中（其中调用RebalanceImpl实例的computePullFromWhere(MessageQueue mq)方法获取该MessageQueue对象的下一个进度消费值offset，随后填充至接下来要创建的pullRequest对象属性中），并创建拉取请求对象—pullRequest添加到拉取列表—pullRequestList中，最后执行dispatchPullRequest()方法，将Pull消息的请求对象PullRequest依次放入PullMessageService服务线程的阻塞队列pullRequestQueue中，待该服务线程取出后向Broker端发起Pull消息的请求。其中，可以重点对比下，RebalancePushImpl和RebalancePullImpl两个实现类的dispatchPullRequest()方法不同，RebalancePullImpl类里面的该方法为空，这样子也就回答了上一篇中最后的那道思考题了。</p>
<p>消息消费队列在同一消费组不同消费者之间的负载均衡，其核心设计理念是在一个消息消费队列在同一时间只允许被同一消费组内的一个消费者消费，一个消息消费者能同时消费多个消息队列。</p>
</li>
</ol>
<h1 id="5、事务消息"><a href="#5、事务消息" class="headerlink" title="5、事务消息"></a>5、事务消息</h1><p>Apache RocketMQ在4.3.0版中已经支持分布式事务消息，RocketMQ采用了【2PC思想】实现了提交事务消息，同时增加一个补偿逻辑来处理二阶段超时或者失败的消息，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-RocketMQ%E8%AE%BE%E8%AE%A1-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.png"></p>
<h2 id="5-1、事务消息流程"><a href="#5-1、事务消息流程" class="headerlink" title="5.1、事务消息流程"></a>5.1、事务消息流程</h2><p>事务消息主要分两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p>
<ol>
<li><p>事务消息发送及提交</p>
<ol>
<li>发送消息（half消息）；</li>
<li>服务端响应消息写入结果；</li>
<li>根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）；</li>
<li>根据本地事务状态执行Commit或者Rollback（Commit操作生成消息索引，消息对消费者可见）；</li>
</ol>
</li>
<li><p>补偿流程</p>
<ol>
<li>对没有Commit&#x2F;Rollback的事务消息（pending状态的消息），从服务端发起一次“回查”；</li>
<li>Producer收到回查消息，检查回查消息对应的本地事务的状态；</li>
<li>根据本地事务状态，重新Commit或者Rollback；</li>
</ol>
<p>补偿阶段用于解决消息Commit或者Rollback发生超时或者失败的情况。</p>
</li>
</ol>
<h2 id="5-2、RocketMQ事务消息设计"><a href="#5-2、RocketMQ事务消息设计" class="headerlink" title="5.2、RocketMQ事务消息设计"></a>5.2、RocketMQ事务消息设计</h2><h3 id="5-2-1、事务消息在一阶段对用户不可见"><a href="#5-2-1、事务消息在一阶段对用户不可见" class="headerlink" title="5.2.1、事务消息在一阶段对用户不可见"></a>5.2.1、事务消息在一阶段对用户不可见</h3><p><strong>在RocketMQ事务消息的主要流程中，事务消息在一阶段对用户不可见。</strong>如何做到不可见呢？RocketMQ事务消息的做法是：<strong>如果消息是half消息，将备份原消息的主题与消息消费队列，然后改变主题为RMQ_SYS_TRANS_HALF_TOPIC。</strong>由于消费组未订阅该主题，故消费端无法消费half类型的消息，然后RocketMQ会开启一个定时任务，从Topic为RMQ_SYS_TRANS_HALF_TOPIC中拉取消息进行消费，生产者组发送回查事务状态请求，根据事务状态来决定是提交或回滚消息。</p>
<p>消息在服务端的存储结构如下，每条消息都会有对应的索引信息，Consumer通过ConsumeQueue这个二级索引来读取消息实体内容，其流程如下：</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-image-20210819185955464.png"></p>
<p>RocketMQ具体实现策略：如果写入的是事务消息，则对该消息的Topic和Queue等属性进行替换，同时将原来的Topic和Queue信息存储到消息属性中，正因为消息主题被替换，故消息并不会转发到该原主题的消息消费队列，消费者无法感知消息的存在，不会消费。其实改变消息主题是RocketMQ的常用“套路”，回想一下延时消息的实现机制。</p>
<h3 id="5-2-2、Commit和Rollback操作以及Op消息引入"><a href="#5-2-2、Commit和Rollback操作以及Op消息引入" class="headerlink" title="5.2.2、Commit和Rollback操作以及Op消息引入"></a>5.2.2、Commit和Rollback操作以及Op消息引入</h3><p><strong>在完成一阶段（写入一条对用户不可见的消息）后，二阶段如果是Commit操作，则需要使得消息对用户可见；如果是Rollback则需要撤销一阶段的消息。</strong></p>
<p>对于Rollback，本身一阶段的消息对用户是不可见的，其实不需要真正撤销消息（实际上RocketMQ也无法去真正的删除一条消息，因为是顺序写文件的）。但为了标记这条消息没有确定状态（Pending状态，事务悬而未决），则需要一个操作来标识这条消息的最终状态。</p>
<p><strong>RocketMQ事务消息方案中引入了Op消息概念，用Op消息标识事务消息已经确定的状态（Commit或者Rollback）。</strong>如果一条事务消息没有对应的Op消息，说明这个事务的状态还无法确定（可能是二阶段失败了）。引入Op消息后，事务消息无论是Commit或者Rollback都会记录一个Op操作。Commit相对于Rollback只是在写入Op消息前创建Half消息的索引。</p>
<h3 id="5-2-3、Op消息的存储和对应关系"><a href="#5-2-3、Op消息的存储和对应关系" class="headerlink" title="5.2.3、Op消息的存储和对应关系"></a>5.2.3、Op消息的存储和对应关系</h3><p>通过TransactionalMessageUtil.buildOpTopic()方法可将Op消息写入到一个特定Topic中，这个Topic是一个内部Topic（像Half消息的Topic一样），故不会被用户消费。Op消息的内容为对应的Half消息的存储的Offset，这样通过Op消息能索引到Half消息进行后续的回查操作。</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-image-20210819190132751.png"></p>
<h3 id="5-2-4、Half消息的索引构建"><a href="#5-2-4、Half消息的索引构建" class="headerlink" title="5.2.4、Half消息的索引构建"></a>5.2.4、Half消息的索引构建</h3><p><strong>在执行二阶段Commit操作时需要构建出Half消息的索引。</strong>一阶段的Half消息由于是写到一个特殊的Topic，所以二阶段构建索引时需要读取Half消息，并将Topic和Queue替换成真正的Topic和Queue，之后通过一次普通消息的写入操作来生成一条对用户可见的消息。所以RocketMQ事务消息二阶段其实是利用了一阶段存储的消息内容，在二阶段时恢复出一条完整的普通消息，然后走一遍消息写入流程。</p>
<h3 id="5-2-5、如何处理二阶段失败的消息"><a href="#5-2-5、如何处理二阶段失败的消息" class="headerlink" title="5.2.5、如何处理二阶段失败的消息"></a>5.2.5、如何处理二阶段失败的消息</h3><p><strong>如果事务消息的二阶段失败了，那么RocketMQ提出了一种补偿机制，称为回查。</strong>Broker端对未确定状态的消息发起回查，将消息发送到对应的Producer端（同一个Group的Producer），由Producer根据消息来检查本地事务的状态，进而执行Commit或者Rollback。Broker端通过对比Half消息和Op消息进行事务消息的回查并且推进CheckPoint（记录那些事务消息的状态是确定的）。</p>
<p><font color='red'>注意：rocketmq并不会无休止执行信息事务状态回查，默认回查15次，如果15次回查还是无法得知事务状态，rocketmq默认回滚该消息。</font></p>
<h2 id="5-3、使用限制"><a href="#5-3、使用限制" class="headerlink" title="5.3、使用限制"></a>5.3、使用限制</h2><ol>
<li>事务消息 不支持 延时消息 和 批量消息。</li>
<li>为避免 单个消息被检查太多次而导致半队列消息累积，默认将检查次数限制为 15 次，但是用户可以通过 Broker配置文件的 <code>transactionCheckMax</code>参数来修改此限制。如果检查某条消息的次数超过 N 次的话（ N &#x3D; <code>transactionCheckMax</code> ） 则 Broker 将丢弃此消息，并默认同时打印错误日志。用户可以通过重写 <code>AbstractTransactionCheckListener</code> 类来修改这个行为。</li>
<li>事务消息 将在特定时间后被检查，该时间由Broker配置文件中的参数transactionMsgTimeout决定 。当发送事务消息时，用户还可以通过设置用户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 <code>transactionMsgTimeout</code> 参数。</li>
<li>事务性消息可能不止一次被检查或消费。</li>
<li>提交给用户的目标主题消息可能会失败，目前 依据 日志的记录 而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事务消息不丢失、且保证事务的完整性，那么建议使用同步的双重写入机制。</li>
<li>事务消息的生产者ID 不能 与其他类型消息的生产者ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ服务器能通过它们的生产者ID 查询到 消费者。</li>
</ol>
<h1 id="6、消息查询"><a href="#6、消息查询" class="headerlink" title="6、消息查询"></a>6、消息查询</h1><p><strong>RocketMQ支持 按照Message Id查询消息、按照Message Key查询消息 两种方式。</strong></p>
<h2 id="6-1、按照MessageId查询消息"><a href="#6-1、按照MessageId查询消息" class="headerlink" title="6.1、按照MessageId查询消息"></a>6.1、按照MessageId查询消息</h2><p><strong>MessageId长度共16字节，包含了消息存储主机地址（IP地址和端口），消息Commit Log offset。</strong></p>
<p>按照MessageId查询消息具体做法：Client端从MessageId中解析出 Broker地址（IP地址和端口）和 Commit Log偏移地址后 封装成一个RPC请求后通过Remoting通信层发送（业务请求码：VIEW_MESSAGE_BY_ID）。Broker端走的是QueryMessageProcessor，读取消息的过程使用 commitLog offset 和 size 去 commitLog 中找到记录并解析成一个完整的消息并返回。</p>
<h2 id="6-2、按照Message-Key查询消息"><a href="#6-2、按照Message-Key查询消息" class="headerlink" title="6.2、按照Message Key查询消息"></a>6.2、按照Message Key查询消息</h2><p>“按照Message Key查询消息” 是基于RocketMQ的IndexFile索引文件来实现。RocketMQ索引文件逻辑结构，类似JDK中HashMap。索引文件结构如下：</p>
<p><img src="https://raw.githubusercontent.com/lucky2shh/blog-haogeblogs-image/master/2023/08/07/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-image-20210819190354734.png"></p>
<p>IndexFile索引文件 为用户提供 消息索引查询服务，IndexFile文件存储位置是：$HOME\store\index${fileName}，文件名fileName是以创建时的时间戳命名，文件大小是固定的，等于40+500W * 4+2000W * 20&#x3D; 420000040个字节大小。如果消息的properties中设置了UNIQ_KEY属性，就用 topic + “#” + UNIQ_KEY的value 作为 key 来做写入操作。如果消息设置了KEYS属性（多个KEY以空格分隔），也会用 topic + “#” + KEY 来做索引。</p>
<p><strong>索引数据包含了Key Hash &#x2F; CommitLog Offset &#x2F; Timestamp &#x2F; NextIndex offset 四个字段，一共20 Byte。</strong>NextIndex offset 即前面读出来的 slotValue，如果有 hash冲突，就可以用这个字段将所有冲突的索引用链表的方式串起来了。Timestamp记录的是消息storeTimestamp之间的差，并不是一个绝对的时间。整个Index File的结构如图，40 Byte 的Header用于保存一些总的统计信息，4<em>500W的 Slot Table并不保存真正的索引数据，而是保存每个槽位对应的单向链表头。20</em>2000W 是真正的索引数据，即一个 Index File 可以保存 2000W个索引。</p>
<p>按照Message Key查询消息 具体做法：主要通过Broker端的QueryMessageProcessor业务处理器来查询，读取消息的过程就是用topic和key找到IndexFile索引文件中的一条记录，根据commitLog offset从CommitLog文件中读取消息的实体内容。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">豪哥</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://hshz21.gitee.io/2023/08/07/rocketmq-di-ceng-yuan-li/">https://hshz21.gitee.io/2023/08/07/rocketmq-di-ceng-yuan-li/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">豪哥</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/RocketMQ/">
                                    <span class="chip bg-color">RocketMQ</span>
                                </a>
                            
                                <a href="/tags/RocketMQ%E5%8E%9F%E7%90%86/">
                                    <span class="chip bg-color">RocketMQ原理</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wxpay.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/08/07/rocketmq-ji-chu-ying-yong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="RocketMQ系列-RocketMQ基础应用">
                        
                        <span class="card-title">RocketMQ系列-RocketMQ基础应用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-08-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/RocketMQ/" class="post-category">
                                    RocketMQ
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/RocketMQ/">
                        <span class="chip bg-color">RocketMQ</span>
                    </a>
                    
                    <a href="/tags/RocketMQ%E5%9F%BA%E7%A1%80/">
                        <span class="chip bg-color">RocketMQ基础</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/08/07/rabbitmq-jie-jue-fang-an/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="RabbitMQ系列-RabbitMQ常见业务问题">
                        
                        <span class="card-title">RabbitMQ系列-RabbitMQ常见业务问题</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-08-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/RabbitMQ/" class="post-category">
                                    RabbitMQ
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/RabbitMQ/">
                        <span class="chip bg-color">RabbitMQ</span>
                    </a>
                    
                    <a href="/tags/RabbitMQ%E9%97%AE%E9%A2%98/">
                        <span class="chip bg-color">RabbitMQ问题</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">豪哥</a>
            |&nbsp;Powered by&nbsp;<a href="https://github.com/lucky2shh" target="_blank">豪哥</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:3577293158@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3577293158" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3577293158" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
