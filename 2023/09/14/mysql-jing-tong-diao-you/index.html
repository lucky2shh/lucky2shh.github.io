<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQL系列-MySQL调优, 豪哥博客">
    <meta name="description" content="豪哥个人博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MySQL系列-MySQL调优 | 豪哥博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">豪哥博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">豪哥博客</div>
        <div class="logo-desc">
            
            豪哥个人博客
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MySQL系列-MySQL调优</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MySQL/">
                                <span class="chip bg-color">MySQL</span>
                            </a>
                        
                            <a href="/tags/MySQL%E8%B0%83%E4%BC%98/">
                                <span class="chip bg-color">MySQL调优</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/MySQL/" class="post-category">
                                MySQL
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-09-14
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-10-03
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.7k
                </div>
                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1、优化概述"><a href="#1、优化概述" class="headerlink" title="1、优化概述"></a>1、优化概述</h1><p>优化分为几种类型：</p>
<ul>
<li>数据库级别优化；</li>
<li>硬件级别优化；</li>
<li>平衡便捷性和性能；</li>
</ul>
<h2 id="1-1、数据库级别优化"><a href="#1-1、数据库级别优化" class="headerlink" title="1.1、数据库级别优化"></a>1.1、数据库级别优化</h2><p>数据库快速运行依赖于以下几项：</p>
<ol>
<li>正确的表结构、正确的列数据类型、必须的列；</li>
<li>正确优秀的索引设计；</li>
<li>正确合适的存储引擎；</li>
<li>表中采用正确的行格式；</li>
<li>正确的锁设计（行锁、表锁等）；</li>
<li>正确的缓存大小，这些缓存主要是<code>InnoDB</code>缓冲池，<code>MyISAM</code>键高速缓存和MySQL查询高速缓存；</li>
</ol>
<h2 id="1-2、硬件级别优化"><a href="#1-2、硬件级别优化" class="headerlink" title="1.2、硬件级别优化"></a>1.2、硬件级别优化</h2><p>系统瓶颈通常有以下来源：</p>
<ol>
<li><p>磁盘搜索</p>
<p>磁盘查找数据需要花费时间。对于现代磁盘，此操作的平均时间通常小于10毫秒，因此理论上我们可以执行约100秒钟的搜索。这段时间随着新磁盘的使用而缓慢改善，并且很难为单个表进行优化。优化寻道时间的方法是将数据分发到多个磁盘上。</p>
</li>
<li><p>磁盘读写</p>
<p>当磁盘位于正确的位置时，我们需要读取或写入数据。对于现代磁盘，一个磁盘至少可提供10–20MB &#x2F; s的吞吐量。与查找相比，优化起来更容易，因为您可以从多个磁盘并行读取。</p>
</li>
<li><p>CPU周期</p>
<p>当数据位于主存储器中时，我们必须对其进行处理以获得结果。与内存量相比，拥有较大的表是最常见的限制因素。但是对于小表，速度通常不是问题。</p>
</li>
<li><p>内存带宽</p>
<p>当CPU需要的数据超出CPU缓存的容量时，主内存带宽将成为瓶颈。对于大多数系统来说，这是一个不常见的瓶颈，但是要意识到这一点。</p>
</li>
</ol>
<h2 id="1-3、平衡便捷性和性能"><a href="#1-3、平衡便捷性和性能" class="headerlink" title="1.3、平衡便捷性和性能"></a>1.3、平衡便捷性和性能</h2><p>MySQL Server支持三种注释样式：</p>
<ul>
<li>从<code>#</code>字符到行尾</li>
<li>从<code>-- </code>序列到行尾。在MySQL中，<code>-- </code>（双破折号）注释样式要求第二个破折号后必须至少包含一个空格或控制字符（例如空格，制表符，换行符等）。此语法与标准SQL注释语法略有不同。</li>
<li>从一个<code>/*</code>序列到以下 <code>*/</code>序列。此语法使注释可以扩展到多行，因为开始和结束序列不必在同一行上。</li>
</ul>
<p>下面演示了三种注释样式：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment"># This comment continues to the end of line</span>
mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">-- This comment continues to the end of line</span>
mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token number">1</span> 	  <span class="token comment">/* this is an in-line comment */</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token operator">+</span>
<span class="token comment">/*
this is a
multiple-line comment
*/</span>
<span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="2、优化SQL语句"><a href="#2、优化SQL语句" class="headerlink" title="2、优化SQL语句"></a>2、优化SQL语句</h1><h2 id="2-1、优化select语句"><a href="#2-1、优化select语句" class="headerlink" title="2.1、优化select语句"></a>2.1、优化select语句</h2><h3 id="2-1-1-WHERE子句优化"><a href="#2-1-1-WHERE子句优化" class="headerlink" title="2.1.1 WHERE子句优化"></a>2.1.1 WHERE子句优化</h3><ol>
<li><p>删除不必要的括号；</p>
</li>
<li><p>恒定折叠；</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span>a<span class="token operator">&lt;</span>b <span class="token operator">AND</span> b<span class="token operator">=</span>c<span class="token punctuation">)</span> <span class="token operator">AND</span> a<span class="token operator">=</span><span class="token number">5</span>   <span class="token operator">-</span><span class="token operator">></span>    b<span class="token operator">></span><span class="token number">5</span> <span class="token operator">AND</span> b<span class="token operator">=</span>c <span class="token operator">AND</span> a<span class="token operator">=</span><span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>恒定条件删除；</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span>b<span class="token operator">>=</span><span class="token number">5</span> <span class="token operator">AND</span> b<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">OR</span> <span class="token punctuation">(</span>b<span class="token operator">=</span><span class="token number">6</span> <span class="token operator">AND</span> <span class="token number">5</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">OR</span> <span class="token punctuation">(</span>b<span class="token operator">=</span><span class="token number">7</span> <span class="token operator">AND</span> <span class="token number">5</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>   <span class="token operator">-</span><span class="token operator">></span>  b<span class="token operator">=</span><span class="token number">5</span> <span class="token operator">OR</span> b<span class="token operator">=</span><span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>索引使用的表达式仅计算一次；</p>
</li>
<li><p>没有<code>WHERE</code>的单个 table 上的<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_count">COUNT(*)</a>是直接从<code>MyISAM</code>和<code>MEMORY</code>table 的 table 信息中检索的。当仅与一个 table 一起使用时，对于任何<code>NOT NULL</code>表达式也将执行此操作。</p>
</li>
<li><p>早期检测无效的常量 table 达式。 MySQL 快速检测到某些<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html">SELECT</a>语句是不可能的，并且不返回任何行。</p>
</li>
<li><p>如果您不使用<code>GROUP BY</code>或集合函数(<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_count">COUNT()</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_min">MIN()</a>等)，则<code>HAVING</code>与<code>WHERE</code>合并。</p>
</li>
<li><p>对于联接中的每个 table，构造一个更简单的<code>WHERE</code>以获得 table 的快速<code>WHERE</code>评估，并尽快跳过行。</p>
</li>
<li><p>在查询中的所有其他 table 之前，首先读取所有常量 table。常量 table 可以是以下任意一个：</p>
<ul>
<li>空表或具有一行的表。</li>
<li>与a或 索引<code>WHERE</code> 上的子句一起使用的表，其中所有索引部分都与常量表达式进行比较，并定义为。 <code>PRIMARY KEY``UNIQUE``NOT NULL</code></li>
</ul>
<p>以下所有表均用作常量表：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> primary_key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t1<span class="token punctuation">,</span>t2
  <span class="token keyword">WHERE</span> t1<span class="token punctuation">.</span>primary_key<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> t2<span class="token punctuation">.</span>primary_key<span class="token operator">=</span>t1<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>通过尝试所有可能的方法，找到用于联接 table 的最佳联接组合。如果<code>ORDER BY</code>和<code>GROUP BY</code>子句中的所有列都来自同一 table，则在联接时优先使用该 table。</p>
</li>
<li><p>如果有一个<code>ORDER BY</code>子句和另一个<code>GROUP BY</code>子句，或者<code>ORDER BY</code>或<code>GROUP BY</code>包含联接队列中第一个 table 以外的 table 中的列，则会创建一个临时 table。</p>
</li>
<li><p>如果使用<code>SQL_SMALL_RESULT</code>修饰符，则 MySQL 使用内存中的临时 table。</p>
</li>
<li><p>查询每个 table 索引，并使用最佳索引，除非优化程序认为使用 table 扫描更有效。一次使用扫描是基于最佳索引是否跨越了 table 的 30％以上，但是固定百分比不再决定使用索引还是扫描。现在，优化器更加复杂，其估计基于其他因素，例如 table 大小，行数和 I&#x2F;O 块大小。</p>
</li>
<li><p>在某些情况下，MySQL 甚至可以在不查询数据文件的情况下从索引中读取行。如果索引中使用的所有列都是数字，则仅索引树用于解析查询。</p>
</li>
<li><p>在输出每一行之前，将跳过与<code>HAVING</code>子句不匹配的行。</p>
</li>
</ol>
<h3 id="2-1-2、范围优化"><a href="#2-1-2、范围优化" class="headerlink" title="2.1.2、范围优化"></a>2.1.2、范围优化</h3><ol>
<li>单部分索引的范围访问方法</li>
<li>多部分索引的范围访问方法</li>
<li>多值比较的等距范围优化</li>
<li>行构造函数表达式的范围优化</li>
<li>限制内存使用以进行范围优化</li>
</ol>
<h3 id="2-1-3、索引合并优化"><a href="#2-1-3、索引合并优化" class="headerlink" title="2.1.3、索引合并优化"></a>2.1.3、索引合并优化</h3><h3 id="2-1-4、发动机状态下推优化"><a href="#2-1-4、发动机状态下推优化" class="headerlink" title="2.1.4、发动机状态下推优化"></a>2.1.4、发动机状态下推优化</h3><h3 id="2-1-5、索引条件下推优化"><a href="#2-1-5、索引条件下推优化" class="headerlink" title="2.1.5、索引条件下推优化"></a>2.1.5、索引条件下推优化</h3><h3 id="2-1-6、嵌套循环联接算法"><a href="#2-1-6、嵌套循环联接算法" class="headerlink" title="2.1.6、嵌套循环联接算法"></a>2.1.6、嵌套循环联接算法</h3><h3 id="2-1-7、嵌套联接优化"><a href="#2-1-7、嵌套联接优化" class="headerlink" title="2.1.7、嵌套联接优化"></a>2.1.7、嵌套联接优化</h3><h3 id="2-1-8、外部联接优化"><a href="#2-1-8、外部联接优化" class="headerlink" title="2.1.8、外部联接优化"></a>2.1.8、外部联接优化</h3><h3 id="2-1-9、外部联接简化"><a href="#2-1-9、外部联接简化" class="headerlink" title="2.1.9、外部联接简化"></a>2.1.9、外部联接简化</h3><h3 id="2-1-10、多范围读取优化"><a href="#2-1-10、多范围读取优化" class="headerlink" title="2.1.10、多范围读取优化"></a>2.1.10、多范围读取优化</h3><h3 id="2-1-11、块嵌套循环和批处理密钥访问联接"><a href="#2-1-11、块嵌套循环和批处理密钥访问联接" class="headerlink" title="2.1.11、块嵌套循环和批处理密钥访问联接"></a>2.1.11、块嵌套循环和批处理密钥访问联接</h3><h3 id="2-1-12、条件过滤"><a href="#2-1-12、条件过滤" class="headerlink" title="2.1.12、条件过滤"></a>2.1.12、条件过滤</h3><h3 id="2-1-13、IS-NULL优化"><a href="#2-1-13、IS-NULL优化" class="headerlink" title="2.1.13、IS NULL优化"></a>2.1.13、IS NULL优化</h3><h3 id="2-1-14、按优化排序"><a href="#2-1-14、按优化排序" class="headerlink" title="2.1.14、按优化排序"></a>2.1.14、按优化排序</h3><h3 id="2-1-15、按优化分组"><a href="#2-1-15、按优化分组" class="headerlink" title="2.1.15、按优化分组"></a>2.1.15、按优化分组</h3><h3 id="2-1-16、DISTINCT优化"><a href="#2-1-16、DISTINCT优化" class="headerlink" title="2.1.16、DISTINCT优化"></a>2.1.16、DISTINCT优化</h3><h3 id="2-1-17、LIMIT查询优化"><a href="#2-1-17、LIMIT查询优化" class="headerlink" title="2.1.17、LIMIT查询优化"></a>2.1.17、LIMIT查询优化</h3><h3 id="2-1-18、函数调用优化"><a href="#2-1-18、函数调用优化" class="headerlink" title="2.1.18、函数调用优化"></a>2.1.18、函数调用优化</h3><h3 id="2-1-19、行构造器表达式优化"><a href="#2-1-19、行构造器表达式优化" class="headerlink" title="2.1.19、行构造器表达式优化"></a>2.1.19、行构造器表达式优化</h3><h3 id="2-1-20、避免全表扫描"><a href="#2-1-20、避免全表扫描" class="headerlink" title="2.1.20、避免全表扫描"></a>2.1.20、避免全表扫描</h3><h2 id="2-2、优化子查询、派生表和视图引用"><a href="#2-2、优化子查询、派生表和视图引用" class="headerlink" title="2.2、优化子查询、派生表和视图引用"></a>2.2、优化子查询、派生表和视图引用</h2><p>MySQL 查询优化器有多种策略可用于评估子查询：</p>
<ul>
<li>对于<code>IN</code>(或<code>=ANY</code>)子查询，优化器具有以下选择：</li>
<li>Semijoin<ul>
<li>Materialization</li>
<li><code>EXISTS</code>策略</li>
</ul>
</li>
<li>对于<code>NOT IN</code>(或<code>&lt;&gt;ALL</code>)子查询，优化器具有以下选择：</li>
<li>Materialization<ul>
<li><code>EXISTS</code>策略</li>
</ul>
</li>
</ul>
<p>对于派生 table，优化器具有以下选择(这也适用于视图引用)：</p>
<ul>
<li>将派生 table 合并到外部查询块中</li>
<li>将派生 table 具体化为内部临时 table</li>
</ul>
<h3 id="2-2-1、使用半联接转换优化子查询，派生-table-和视图引用"><a href="#2-2-1、使用半联接转换优化子查询，派生-table-和视图引用" class="headerlink" title="2.2.1、使用半联接转换优化子查询，派生 table 和视图引用"></a>2.2.1、使用半联接转换优化子查询，派生 table 和视图引用</h3><h3 id="2-2-2、通过物化优化子查询"><a href="#2-2-2、通过物化优化子查询" class="headerlink" title="2.2.2、通过物化优化子查询"></a>2.2.2、通过物化优化子查询</h3><h3 id="2-2-3、使用exists策略优化子查询"><a href="#2-2-3、使用exists策略优化子查询" class="headerlink" title="2.2.3、使用exists策略优化子查询"></a>2.2.3、使用exists策略优化子查询</h3><h3 id="2-2-4、通过合并或实现来优化派生表和视图引用"><a href="#2-2-4、通过合并或实现来优化派生表和视图引用" class="headerlink" title="2.2.4、通过合并或实现来优化派生表和视图引用"></a>2.2.4、通过合并或实现来优化派生表和视图引用</h3><p>优化器可以使用两种策略来处理派生表引用（这也适用于视图引用）：</p>
<ul>
<li>将派生表合并到外部查询块中</li>
<li>将派生表具体化为内部临时表</li>
</ul>
<h2 id="2-3、优化INFORMATION-SCHEMA查询"><a href="#2-3、优化INFORMATION-SCHEMA查询" class="headerlink" title="2.3、优化INFORMATION_SCHEMA查询"></a>2.3、优化INFORMATION_SCHEMA查询</h2><p>监视数据库的应用程序可能会频繁使用<code>INFORMATION_SCHEMA</code>table。可以对<code>INFORMATION_SCHEMA</code>table 的某些类型的查询进行优化以更快地执行。目标是最大程度地减少文件操作(例如，扫描目录或打开 table 文件)以收集构成这些动态 table 的信息。</p>
<ol>
<li>尝试对<code>WHERE</code>子句中的数据库和 table 名使用常量查找值；</li>
<li>编写查询以最小化必须打开的 table 文件的数量；</li>
<li>使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>确定服务器是否可以对查询使用<code>INFORMATION_SCHEMA</code>优化；</li>
</ol>
<h2 id="2-4、优化数据更改语句"><a href="#2-4、优化数据更改语句" class="headerlink" title="2.4、优化数据更改语句"></a>2.4、优化数据更改语句</h2><h3 id="2-4-1、优化insert语句"><a href="#2-4-1、优化insert语句" class="headerlink" title="2.4.1、优化insert语句"></a>2.4.1、优化insert语句</h3><p>为了优化插入速度，请将许多小操作合并为一个大操作。理想情况下，您进行单个连接，一次发送许多新行的数据，并将所有索引更新和一致性检查延迟到最后。</p>
<p>插入行所需的时间由以下因素决定，其中数字表示近似比例：</p>
<ul>
<li>Connecting: (3)</li>
<li>向服务器发送查询：(2)</li>
<li>解析查询：(2)</li>
<li>插入行：(1×行大小)</li>
<li>插入索引：(1×索引数)</li>
<li>Closing: (1)</li>
</ul>
<h3 id="2-4-2、优化update语句"><a href="#2-4-2、优化update语句" class="headerlink" title="2.4.2、优化update语句"></a>2.4.2、优化update语句</h3><p>优化了一条更新语句，类似于<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html">SELECT</a>查询，但具有额外的写操作开销。写入速度取决于要更新的数据量和要更新的索引数。不变的索引不会更新。</p>
<p>获得快速更新的另一种方法是延迟更新，然后在以后连续进行许多更新。如果锁定 table，一起执行多个更新要比一次执行一次更新快得多。</p>
<p>对于使用动态行格式的<code>MyISAM</code>table，将行更新为更长的总长度可能会拆分该行。</p>
<h3 id="2-4-3、优化delete语句"><a href="#2-4-3、优化delete语句" class="headerlink" title="2.4.3、优化delete语句"></a>2.4.3、优化delete语句</h3><p>删除<code>MyISAM</code>table 中的各个行所需的时间与索引的数量成正比。要更快地删除行，可以通过增加<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_key_buffer_size">key_buffer_size</a>系统变量来增加键高速缓存的大小。</p>
<p>要删除<code>MyISAM</code>table 中的所有行，<code>TRUNCATE TABLE tbl_name</code>比<code>DELETE FROM tbl_name</code>快。截断操作不是事务安全的；</p>
<h2 id="2-5、优化数据库特权"><a href="#2-5、优化数据库特权" class="headerlink" title="2.5、优化数据库特权"></a>2.5、优化数据库特权</h2><p>权限设置越复杂，所有 SQL 语句的开销就越大。简化由<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/grant.html">GRANT</a>语句构建的特权，可使 MySQL 减少 Client 端执行语句时进行权限检查的开销。例如，如果您不授予任何 table 级或列级特权，则服务器无需检查<code>tables_priv</code>和<code>columns_priv</code>table 的内容。同样，如果您没有对任何帐户设置资源限制，则服务器不必执行资源计数。如果您有很高的语句处理负载，请考虑使用简化的授予结构以减少权限检查的开销。</p>
<h2 id="2-6、其它优化"><a href="#2-6、其它优化" class="headerlink" title="2.6、其它优化"></a>2.6、其它优化</h2><ol>
<li>如果您的应用程序发出多个数据库请求以执行相关更新，则将这些语句组合到存储的例程中可以帮助提高性能。同样，如果您的应用程序根据多个列值或大量数据计算单个结果，则将计算结果合并到 UDF(用户定义的函数)中可以提高性能。然后，产生的快速数据库操作可用于其他查询，应用程序，甚至可以用不同的编程语言编写的代码重用。</li>
<li>要解决<code>ARCHIVE</code>table 出现的任何压缩问题，请使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimize-table.html">OPTIMIZE TABLE</a>。</li>
<li>如果可能，将报告分类为“实时”或“统计”，其中仅根据从实时数据定期生成的汇总表中创建统计报告所需的数据。</li>
<li>如果您的数据与行和列的 table 结构不一致，则可以将数据打包并存储到<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">BLOB</a>列中。在这种情况下，您必须在应用程序中提供代码以打包和解压缩信息，但这可能会节省 I&#x2F;O 操作，以读写相关值集。</li>
<li>对于 Web 服务器，将图像和其他二进制资产存储为文件，路径名存储在数据库中，而不是文件本身。大多数 Web 服务器比文件内容在缓存文件方面更胜一筹，因此使用文件通常更快。</li>
<li>如果您确实需要很高的速度，请查看底层的 MySQL 接口。</li>
</ol>
<h1 id="3、优化索引"><a href="#3、优化索引" class="headerlink" title="3、优化索引"></a>3、优化索引</h1><p>MySQL使用索引的好处：</p>
<ol>
<li>快速查找与where子句匹配的行；</li>
<li>从考虑中消除行；</li>
<li>如果表具有多列索引，则优化器可以使用索引的任何最左前缀来查找行；</li>
<li>执行连接时从其它表中检索行；</li>
</ol>
<h2 id="3-1、主键优化"><a href="#3-1、主键优化" class="headerlink" title="3.1、主键优化"></a>3.1、主键优化</h2><p>table主键表示您在最重要的查询中使用的一列或一组列。它具有关联的索引，可提高查询性能。查询性能受益于<code>NOT NULL</code>优化，因为它不能包含任何<code>NULL</code>值。使用<code>InnoDB</code>存储引擎，可以对 table 数据进行物理组织，以根据一个或多个主键列进行超快速查找和排序。</p>
<h2 id="3-2、外键优化"><a href="#3-2、外键优化" class="headerlink" title="3.2、外键优化"></a>3.2、外键优化</h2><p>如果一个 table 有许多列，并且您查询了许多不同的列组合，将不常用的数据拆分为单独的 table(每个 table 包含几列)，然后通过复制数字 ID 将它们关联回主 table 可能会比较有效。</p>
<h2 id="3-3、列索引"><a href="#3-3、列索引" class="headerlink" title="3.3、列索引"></a>3.3、列索引</h2><p>索引的最常见类型涉及单个列，该列将来自该列的值的副本存储在数据结构中，从而允许快速查找具有相应列值的行。 B 树数据结构使索引可以在<code>WHERE</code>子句中快速找到与诸如<code>=</code>，<code>&gt;</code>，<code>≤</code>，<code>BETWEEN</code>，<code>IN</code>等的运算符相对应的特定值，一组值或一系列值。</p>
<p>所有存储引擎每个 table 至少支持 16 个索引，并且总索引长度至少为 256 个字节。大多数存储引擎都有更高的限制。</p>
<h3 id="3-3-1、索引前缀"><a href="#3-3-1、索引前缀" class="headerlink" title="3.3.1、索引前缀"></a>3.3.1、索引前缀</h3><p>使用字符串列的索引规范中的<code>col_name(N)</code>语法，可以创建仅使用该列的前* <code>N</code> <em>字符的索引。以这种方式仅索引列值的前缀可以使索引文件小得多。为<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">BLOB</a>或<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">TEXT</a>列构建索引时，</em>必须*为索引指定前缀长度。例如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CREATE TABLE <span class="token builtin class-name">test</span> <span class="token punctuation">(</span>blob_col BLOB, INDEX<span class="token punctuation">(</span>blob_col<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>前缀最长可以为 1000 个字节(对于<code>InnoDB</code>个 table，则为 767 个字节，除非您设置了innodb_large_prefix)。</p>
<h3 id="3-3-2、全文索引"><a href="#3-3-2、全文索引" class="headerlink" title="3.3.2、全文索引"></a>3.3.2、全文索引</h3><p><code>FULLTEXT</code>索引用于全文搜索。仅<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html">InnoDB</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-storage-engine.html">MyISAM</a>存储引擎支持<code>FULLTEXT</code>索引，并且仅支持<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html">CHAR</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html">VARCHAR</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">TEXT</a>列。索引始终在整个列上进行，并且不支持列前缀索引。</p>
<p>优化适用于针对单个<code>InnoDB</code>table 的某些类型的<code>FULLTEXT</code>查询。具有以下 Feature 的查询特别有效：</p>
<ul>
<li><code>FULLTEXT</code>查询仅返回文档 ID 或文档 ID 和搜索排名。</li>
<li><code>FULLTEXT</code>查询以分数的降序对匹配行进行排序，并应用<code>LIMIT</code>子句以获取前 N 个匹配行。为了应用此优化，必须没有<code>WHERE</code>子句，并且只有一个<code>ORDER BY</code>子句按降序排列。</li>
<li><code>FULLTEXT</code>查询仅检索与搜索词匹配的行的<code>COUNT(*)</code>值，而没有其他<code>WHERE</code>子句。将<code>WHERE</code>子句编码为<code>WHERE MATCH(text) AGAINST (&#39;other_text&#39;)</code>，而无需任何<code>&gt; 0</code>比较运算符。</li>
</ul>
<p>对于包含全文 table 达式的查询，MySQL 在查询执行的优化阶段评估这些表达式。优化器不仅查看全文 table 达式并进行估计，而且还在制定执行计划的过程中对它们进行评估。</p>
<p>此行为的含义是，对于全文查询，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>通常比在优化阶段未进行表达式求值的非全文查询的慢。</p>
<h3 id="3-3-3、空间指数"><a href="#3-3-3、空间指数" class="headerlink" title="3.3.3、空间指数"></a>3.3.3、空间指数</h3><p>您可以在空间数据类型上创建索引。 <code>MyISAM</code>和<code>InnoDB</code>支持有关空间类型的 R 树索引。其他存储引擎使用 B 树来索引空间类型(<code>ARCHIVE</code>除外，后者不支持空间类型索引)。</p>
<h3 id="3-3-4、memory引擎中的索引"><a href="#3-3-4、memory引擎中的索引" class="headerlink" title="3.3.4、memory引擎中的索引"></a>3.3.4、memory引擎中的索引</h3><p><code>MEMORY</code>存储引擎默认使用<code>HASH</code>索引，但也支持<code>BTREE</code>索引。</p>
<h2 id="3-4、多列索引"><a href="#3-4、多列索引" class="headerlink" title="3.4、多列索引"></a>3.4、多列索引</h2><p>MySQL 可以创建复合索引(即，多列上的索引)。一个索引最多可以包含 16 列。对于某些数据类型，您可以索引列的前缀。</p>
<p>MySQL 可以将多列索引用于测试索引中所有列的查询，或者仅测试第一列，前两列，前三列等等的查询。如果在索引定义中以正确的 Sequences 指定列，则单个复合索引可以加快对同一 table 的几种查询。</p>
<p>多列索引可以被认为是排序数组，其行包含通过串联索引列的值而创建的值。</p>
<h2 id="3-5、查看索引使用情况"><a href="#3-5、查看索引使用情况" class="headerlink" title="3.5、查看索引使用情况"></a>3.5、查看索引使用情况</h2><p>使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>语句始终检查所有查询是否真的使用您在 table 中创建的索引。</p>
<h2 id="3-6、InnoDB-和-MyISAM-索引统计信息收集"><a href="#3-6、InnoDB-和-MyISAM-索引统计信息收集" class="headerlink" title="3.6、InnoDB 和 MyISAM 索引统计信息收集"></a>3.6、InnoDB 和 MyISAM 索引统计信息收集</h2><p>存储引擎收集有关 table 的统计信息，以供优化器使用。table 统计信息基于值组，其中值组是一组具有相同键前缀值的行。出于优化目的，重要的统计数据是平均值组的大小。</p>
<p>MySQL 通过以下方式使用平均值组大小：</p>
<ul>
<li>估算每次<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-output.html#jointype_ref">ref</a>访问必须读取多少行</li>
<li>估计部分联接将产生多少行；也就是说，这种形式的操作将产生的行数：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span><span class="token punctuation">..</span>.<span class="token punctuation">)</span> JOIN tbl_name ON tbl_name.key <span class="token operator">=</span> <span class="token function">expr</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>随着索引的平均值组大小的增加，该索引在这两个用途中的作用不大，因为每次查找的平均行数增加：为了使索引更好地用于优化目的，最好将每个索引值作为目标 table 中的行数。当给定的索引值产生大量的行时，该索引的用处不大，MySQL 不太可能使用它。</p>
<p>平均值组的大小与 table 基数有关，table 基数是值组的数目。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-index.html">SHOW INDEX</a>语句显示基于* <code>N/S</code> <em>的基数值，其中</em> <code>N</code> <em>是 table 中的行数，而</em> <code>S</code> *是平均值组的大小。该比率在 table 中产生大约数量的值组。</p>
<h2 id="3-7、B-树索引和哈希索引的比较"><a href="#3-7、B-树索引和哈希索引的比较" class="headerlink" title="3.7、B 树索引和哈希索引的比较"></a>3.7、B 树索引和哈希索引的比较</h2><h3 id="3-7-1、B树索引特征"><a href="#3-7-1、B树索引特征" class="headerlink" title="3.7.1、B树索引特征"></a>3.7.1、B树索引特征</h3><p>B 树索引可用于使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_equal">&#x3D;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than">&gt;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than-or-equal">&gt;&#x3D;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than">&lt;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than-or-equal">&lt;&#x3D;</a>或<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between">BETWEEN</a>运算符的 table 达式中的列比较。如果<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like">LIKE</a>的参数是不以通配符开头的常量字符串，则索引也可以用于<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like">LIKE</a>比较。例如，以下<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html">SELECT</a>语句使用索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_name <span class="token keyword">WHERE</span> key_col <span class="token operator">LIKE</span> <span class="token string">'Patrick%'</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tbl_name <span class="token keyword">WHERE</span> key_col <span class="token operator">LIKE</span> <span class="token string">'Pat%_ck%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>以下<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html">SELECT</a>语句不使用索引：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SELECT * FROM tbl_name WHERE key_col LIKE <span class="token string">'%Patrick%'</span><span class="token punctuation">;</span>
SELECT * FROM tbl_name WHERE key_col LIKE other_col<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在第一条语句中，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like">LIKE</a>值以通配符开头。在第二条语句中，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/string-comparison-functions.html#operator_like">LIKE</a>值不是常数。</p>
<p>如果您使用的<code>... LIKE &#39;%string%&#39;</code>和 <code>string</code> 的长度超过三个字符，则 MySQL 使用 Turbo Boyer-Moore 算法初始化字符串的模式，然后使用该模式更快地执行搜索。</p>
<p>如果 <code>col_name</code> 被索引，则使用<code>col_name IS NULL</code>的搜索将使用索引。</p>
<p>不能使用<code>WHERE</code>子句中未涵盖所有<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/logical-operators.html#operator_and">AND</a>级别的任何索引来优化查询。换句话说，为了能够使用索引，必须在每个<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/logical-operators.html#operator_and">AND</a>组中使用索引的前缀。</p>
<p>以下<code>WHERE</code>子句使用索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> index_part1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> index_part2<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">AND</span> other_column<span class="token operator">=</span><span class="token number">3</span>

    <span class="token comment">/* index = 1 OR index = 2 */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> <span class="token keyword">index</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">OR</span> A<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">AND</span> <span class="token keyword">index</span><span class="token operator">=</span><span class="token number">2</span>

    <span class="token comment">/* optimized like "index_part1='hello'" */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> index_part1<span class="token operator">=</span><span class="token string">'hello'</span> <span class="token operator">AND</span> index_part3<span class="token operator">=</span><span class="token number">5</span>

    <span class="token comment">/* Can use index on index1 but not on index2 or index3 */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> index1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> index2<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">OR</span> index1<span class="token operator">=</span><span class="token number">3</span> <span class="token operator">AND</span> index3<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这些<code>WHERE</code>子句<em>不</em>使用索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">/* index_part1 is not used */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> index_part2<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> index_part3<span class="token operator">=</span><span class="token number">2</span>

    <span class="token comment">/*  Index is not used in both parts of the WHERE clause  */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> <span class="token keyword">index</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">OR</span> A<span class="token operator">=</span><span class="token number">10</span>

    <span class="token comment">/* No index spans all rows  */</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WHERE</span> index_part1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">OR</span> index_part2<span class="token operator">=</span><span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有时，即使索引可用，MySQL 也不使用索引。发生这种情况的一种情况是，优化器估计使用索引将需要 MySQL 访问 table 中很大比例的行。 (在这种情况下，table 扫描可能会更快，因为它需要更少的查找.)但是，如果这样的查询使用<code>LIMIT</code>来仅检索某些行，则 MySQL 仍会使用索引，因为它可以更快地找到返回结果的几行。</p>
<h3 id="3-7-2、哈希索引特征"><a href="#3-7-2、哈希索引特征" class="headerlink" title="3.7.2、哈希索引特征"></a>3.7.2、哈希索引特征</h3><ol>
<li>它们仅用于使用<code>=</code>或<code>&lt;=&gt;</code>运算符的相等比较(但非常快)。它们不用于比较运算符(例如<code>&lt;</code>)来查找值的范围。依赖于这种单值查找类型的系统称为“键值存储”。要将 MySQL 用于此类应用程序，请尽可能使用哈希索引。</li>
<li>优化器无法使用哈希索引来加快<code>ORDER BY</code>操作的速度。 (此索引类型不能用于按 Sequences 搜索下一个条目.)</li>
<li>MySQL 无法确定两个值之间大约有多少行(范围优化器使用它来决定使用哪个索引)。如果将<code>MyISAM</code>或<code>InnoDB</code>table 更改为哈希索引<code>MEMORY</code>table，这可能会影响某些查询。</li>
<li>仅整个键可用于搜索行。 (对于 B 树索引，键的任何最左边的前缀都可用于查找行。)</li>
</ol>
<h2 id="3-8、索引扩展的使用"><a href="#3-8、索引扩展的使用" class="headerlink" title="3.8、索引扩展的使用"></a>3.8、索引扩展的使用</h2><p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html">InnoDB</a>通过向其附加主键列来自动扩展每个辅助索引。考虑此 table 定义：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CREATE TABLE t1 <span class="token punctuation">(</span>
  i1 INT NOT NULL DEFAULT <span class="token number">0</span>,
  i2 INT NOT NULL DEFAULT <span class="token number">0</span>,
  d DATE DEFAULT NULL,
  PRIMARY KEY <span class="token punctuation">(</span>i1, i2<span class="token punctuation">)</span>,
  INDEX k_d <span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> InnoDB<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该 table 在第<code>(i1, i2)</code>列上定义了主键。它还在列<code>(d)</code>上定义了辅助索引<code>k_d</code>，但在内部<code>InnoDB</code>扩展了该索引并将其视为<code>(d, i1, i2)</code>列。</p>
<p>在确定如何以及是否使用该索引时，优化器会考虑扩展二级索引的主键列。这可以导致更有效的查询执行计划和更好的性能。</p>
<p>优化器可以将扩展的辅助索引用于<code>ref</code>，<code>range</code>和<code>index_merge</code>索引访问，松散索引扫描访问，联接和排序优化以及<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_min">MIN()</a>&#x2F;<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/aggregate-functions.html#function_max">MAX()</a>优化。</p>
<p>以下示例显示了优化程序是否使用扩展二级索引如何影响执行计划。假设<code>t1</code>填充了以下行：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">INSERT INTO t1 VALUES
<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">1</span>, <span class="token string">'1998-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token string">'1999-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token string">'2000-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">4</span>, <span class="token string">'2001-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">5</span>, <span class="token string">'2002-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">1</span>, <span class="token string">'1998-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">2</span>, <span class="token string">'1999-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">3</span>, <span class="token string">'2000-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">4</span>, <span class="token string">'2001-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">5</span>, <span class="token string">'2002-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">1</span>, <span class="token string">'1998-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">2</span>, <span class="token string">'1999-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">3</span>, <span class="token string">'2000-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">4</span>, <span class="token string">'2001-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">3</span>, <span class="token number">5</span>, <span class="token string">'2002-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">4</span>, <span class="token number">1</span>, <span class="token string">'1998-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">4</span>, <span class="token number">2</span>, <span class="token string">'1999-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">4</span>, <span class="token number">3</span>, <span class="token string">'2000-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">4</span>, <span class="token number">4</span>, <span class="token string">'2001-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">4</span>, <span class="token number">5</span>, <span class="token string">'2002-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">5</span>, <span class="token number">1</span>, <span class="token string">'1998-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">5</span>, <span class="token number">2</span>, <span class="token string">'1999-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">5</span>, <span class="token number">3</span>, <span class="token string">'2000-01-01'</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span><span class="token number">5</span>, <span class="token number">4</span>, <span class="token string">'2001-01-01'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">5</span>, <span class="token number">5</span>, <span class="token string">'2002-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>现在考虑以下查询：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">EXPLAIN SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span> FROM t1 WHERE i1 <span class="token operator">=</span> <span class="token number">3</span> AND d <span class="token operator">=</span> <span class="token string">'2000-01-01'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行计划取决于是否使用扩展索引。</p>
<p>当优化器不考虑索引扩展时，它会将索引<code>k_d</code>仅视为<code>(d)</code>。查询的<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>产生以下结果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> EXPLAIN SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span> FROM t1 WHERE i1 <span class="token operator">=</span> <span class="token number">3</span> AND d <span class="token operator">=</span> <span class="token string">'2000-01-01'</span><span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
           id: <span class="token number">1</span>
  select_type: SIMPLE
        table: t1
         type: ref
possible_keys: PRIMARY,k_d
          key: k_d
      key_len: <span class="token number">4</span>
          ref: const
         rows: <span class="token number">5</span>
        Extra: Using where<span class="token punctuation">;</span> Using index<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当优化器考虑索引扩展时，会将<code>k_d</code>视为<code>(d, i1, i2)</code>。在这种情况下，它可以使用最左边的索引前缀<code>(d, i1)</code>来制定更好的执行计划：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> EXPLAIN SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span> FROM t1 WHERE i1 <span class="token operator">=</span> <span class="token number">3</span> AND d <span class="token operator">=</span> <span class="token string">'2000-01-01'</span><span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
           id: <span class="token number">1</span>
  select_type: SIMPLE
        table: t1
         type: ref
possible_keys: PRIMARY,k_d
          key: k_d
      key_len: <span class="token number">8</span>
          ref: const,const
         rows: <span class="token number">1</span>
        Extra: Using index<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这两种情况下，<code>key</code>table 示优化器将使用辅助索引<code>k_d</code>，但是<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>的输出显示了使用扩展索引的以下改进：</p>
<ul>
<li><code>key_len</code>从 4 字节变为 8 字节，table 示键查找使用的是<code>d</code>和<code>i1</code>列，而不仅仅是<code>d</code>。</li>
<li><code>ref</code>值从<code>const</code>变为<code>const,const</code>，因为键查找使用两个键部分，而不是一个。</li>
<li><code>rows</code>计数从 5 减少到 1，table 示<code>InnoDB</code>应该需要检查较少的行才能产生结果。</li>
<li><code>Extra</code>的值从<code>Using where; Using index</code>变为<code>Using index</code>。这意味着可以仅使用索引读取行，而无需查阅数据行中的列。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-status.html">SHOW STATUS</a>也可以看出使用扩展索引的优化器行为上的差异：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FLUSH TABLE t1<span class="token punctuation">;</span>
FLUSH STATUS<span class="token punctuation">;</span>
SELECT COUNT<span class="token punctuation">(</span>*<span class="token punctuation">)</span> FROM t1 WHERE i1 <span class="token operator">=</span> <span class="token number">3</span> AND d <span class="token operator">=</span> <span class="token string">'2000-01-01'</span><span class="token punctuation">;</span>
SHOW STATUS LIKE <span class="token string">'handler_read%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>前面的语句包括<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-tables">FLUSH TABLES</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-status">FLUSH STATUS</a>以刷新 table 缓存并清除状态计数器。</p>
<p>没有索引 extensions，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-status.html">SHOW STATUS</a>会产生以下结果：</p>
<pre class="line-numbers language-mssql" data-language="mssql"><code class="language-mssql">+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| Handler_read_first    | 0     |
| Handler_read_key      | 1     |
| Handler_read_last     | 0     |
| Handler_read_next     | 5     |
| Handler_read_prev     | 0     |
| Handler_read_rnd      | 0     |
| Handler_read_rnd_next | 0     |
+-----------------------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用索引 extensions，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-status.html">SHOW STATUS</a>产生此结果。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Handler_read_next">Handler_read_next</a>的值从 5 减少到 1，table 明索引的使用效率更高：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>
<span class="token operator">|</span> Variable_name         <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>
<span class="token operator">|</span> Handler_read_first    <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_key      <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_last     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_next     <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_prev     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd_next <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_optimizer_switch">optimizer_switch</a>系统变量的<code>use_index_extensions</code>标志允许控制在确定如何使用<code>InnoDB</code>table 的辅助索引时优化器是否考虑主键列。默认情况下，启用<code>use_index_extensions</code>。要检查禁用索引扩展的使用是否可以提高性能，请使用以下语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> optimizer_switch <span class="token operator">=</span> <span class="token string">'use_index_extensions=off'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>优化程序对索引扩展的使用受制于对索引中关键部分的数量(16)和最大密钥长度(3072 字节)的通常限制。</p>
<h2 id="3-9、优化器对生成的列索引的使用"><a href="#3-9、优化器对生成的列索引的使用" class="headerlink" title="3.9、优化器对生成的列索引的使用"></a>3.9、优化器对生成的列索引的使用</h2><p>MySQL 支持在生成的列上构建索引。例如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">CREATE TABLE t1 <span class="token punctuation">(</span>f1 INT, gc INT AS <span class="token punctuation">(</span>f1 + <span class="token number">1</span><span class="token punctuation">)</span> STORED, INDEX <span class="token punctuation">(</span>gc<span class="token punctuation">))</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>生成的列<code>gc</code>定义为 table 达式<code>f1 + 1</code>。该列也已构建索引，优化程序可以在执行计划构建期间考虑该索引。在以下查询中，<code>WHERE</code>子句引用<code>gc</code>，并且优化器考虑该列上的索引是否产生更有效的计划：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SELECT * FROM t1 WHERE gc <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>即使在查询中没有按名称直接引用那些列的情况下，优化器也可以使用所生成列的索引来生成执行计划。如果<code>WHERE</code>，<code>ORDER BY</code>或<code>GROUP BY</code>子句引用的 table 达式与某些索引生成的列的定义匹配，则会发生这种情况。以下查询不直接引用<code>gc</code>，而是使用与<code>gc</code>的定义匹配的 table 达式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SELECT * FROM t1 WHERE f1 + <span class="token number">1</span> <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>优化器认识到 table 达式<code>f1 + 1</code>与<code>gc</code>的定义匹配，并且<code>gc</code>已被索引，因此它在执行计划构建期间会考虑该索引。您可以使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>查看此内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> EXPLAIN SELECT * FROM t1 WHERE f1 + <span class="token number">1</span> <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
           id: <span class="token number">1</span>
  select_type: SIMPLE
        table: t1
   partitions: NULL
         type: range
possible_keys: gc
          key: gc
      key_len: <span class="token number">5</span>
          ref: NULL
         rows: <span class="token number">1</span>
     filtered: <span class="token number">100.00</span>
        Extra: Using index condition<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实际上，优化器已将 table 达式<code>f1 + 1</code>替换为与 table 达式匹配的生成列的名称。在由<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/show-warnings.html">SHOW WARNINGS</a>显示的扩展<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain.html">EXPLAIN</a>信息中可用的重写查询中，这也很明显：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SHOW WARNINGS<span class="token punctuation">\</span>G
*************************** <span class="token number">1</span>. row ***************************
  Level: Note
   Code: <span class="token number">1003</span>
Message: /* <span class="token keyword">select</span><span class="token comment">#1 */ select `test`.`t1`.`f1` AS `f1`,`test`.`t1`.`gc`</span>
         AS <span class="token variable"><span class="token variable">`</span>gc<span class="token variable">`</span></span> from <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">test</span><span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>t1<span class="token variable">`</span></span> where <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">test</span><span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>t1<span class="token variable">`</span></span><span class="token builtin class-name">.</span><span class="token variable"><span class="token variable">`</span>gc<span class="token variable">`</span></span> <span class="token operator">></span> <span class="token number">9</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下限制和条件适用于优化器对生成的列索引的使用：</p>
<ul>
<li>为了使查询 table 达式与生成的列定义匹配，该 table 达式必须相同并且其结果类型必须相同。例如，如果生成的列 table 达式为<code>f1 + 1</code>，则如果查询使用<code>1 + f1</code>或将<code>f1 + 1</code>(整数 table 达式)与字符串进行比较，则优化器将无法识别匹配项。</li>
<li>优化适用于以下运算符：<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_equal">&#x3D;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than">&lt;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_less-than-or-equal">&lt;&#x3D;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than">&gt;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_greater-than-or-equal">&gt;&#x3D;</a>，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between">BETWEEN</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in">IN()</a>。</li>
</ul>
<p>对于<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between">BETWEEN</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in">IN()</a>以外的运算符，可以用匹配的生成列替换任何一个操作数。对于<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between">BETWEEN</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in">IN()</a>，只能将第一个参数替换为生成的匹配列，而其他参数必须具有相同的结果类型。涉及 JSON 值的比较尚不支持<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_between">BETWEEN</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/comparison-operators.html#operator_in">IN()</a>。</p>
<ul>
<li>必须将生成的列定义为至少包含一个函数调用或前一项中提到的运算符之一的 table 达式。该 table 达式不能包含对另一列的简单引用。例如，<code>gc INT AS (f1) STORED</code>仅由列引用组成，因此不考虑<code>gc</code>上的索引。</li>
<li>为了将字符串与索引生成的列进行比较，索引生成的列通过返回带引号的字符串的 JSON 函数计算值，在列定义中需要<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/json-modification-functions.html#function_json-unquote">JSON_UNQUOTE()</a>才能从函数值中删除多余的引号。 (为了将字符串与函数结果直接进行比较，JSON 比较器会处理引号删除，但是对于索引查找不会发生这种情况.)例如，与其编写这样的列定义：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">doc_name TEXT AS <span class="token punctuation">(</span>JSON_EXTRACT<span class="token punctuation">(</span>jdoc, <span class="token string">'$.name'</span><span class="token punctuation">))</span> STORED<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>像这样写：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">doc_name TEXT AS <span class="token punctuation">(</span>JSON_UNQUOTE<span class="token punctuation">(</span>JSON_EXTRACT<span class="token punctuation">(</span>jdoc, <span class="token string">'$.name'</span><span class="token punctuation">))</span><span class="token punctuation">)</span> STORED<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用后一个定义，优化器可以为这两个比较检测到匹配：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>. WHERE JSON_EXTRACT<span class="token punctuation">(</span>jdoc, <span class="token string">'$.name'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'some_string'</span> <span class="token punctuation">..</span>.
<span class="token punctuation">..</span>. WHERE JSON_UNQUOTE<span class="token punctuation">(</span>JSON_EXTRACT<span class="token punctuation">(</span>jdoc, <span class="token string">'$.name'</span><span class="token punctuation">))</span> <span class="token operator">=</span> <span class="token string">'some_string'</span> <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在列定义中没有<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/json-modification-functions.html#function_json-unquote">JSON_UNQUOTE()</a>的情况下，优化器仅针对这些比较中的第一个比较检测到匹配项。</p>
<ul>
<li>如果优化器无法选择所需的索引，则可以使用索引提示来强制优化器做出其他选择。</li>
</ul>
<h2 id="3-10、TIMESTAMP-列中的索引查询"><a href="#3-10、TIMESTAMP-列中的索引查询" class="headerlink" title="3.10、TIMESTAMP 列中的索引查询"></a>3.10、TIMESTAMP 列中的索引查询</h2><p>时间值作为 UTC 值存储在<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html">TIMESTAMP</a>列中，并且在会话时区和 UTC 之间转换插入和从<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html">TIMESTAMP</a>列中检索的值。 (这与<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/date-and-time-functions.html#function_convert-tz">CONVERT_TZ()</a>函数执行的转换类型相同。如果会话时区为 UTC，则实际上没有时区转换。)</p>
<p>由于诸如夏令时(DST)等本地时区更改的约定，UTC 和非 UTC 时区之间的转换在两个方向上都不是一对一的。不同的 UTC 值在另一个时区可能不会不同。以下示例显示了不同的 UTC 值，它们在非 UTC 时区中变得相同：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE tstable <span class="token punctuation">(</span>ts TIMESTAMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> SET time_zone <span class="token operator">=</span> <span class="token string">'UTC'</span><span class="token punctuation">;</span> -- insert UTC values
mysql<span class="token operator">></span> INSERT INTO tstable VALUES
       <span class="token punctuation">(</span><span class="token string">'2018-10-28 00:30:00'</span><span class="token punctuation">)</span>,
       <span class="token punctuation">(</span><span class="token string">'2018-10-28 01:30:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> SELECT ts FROM tstable<span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> ts                  <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 00:30:00 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 01:30:00 <span class="token operator">|</span>
+---------------------+
mysql<span class="token operator">></span> SET time_zone <span class="token operator">=</span> <span class="token string">'MET'</span><span class="token punctuation">;</span> -- retrieve non-UTC values
mysql<span class="token operator">></span> SELECT ts FROM tstable<span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> ts                  <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
+---------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>您可以看到两个不同的 UTC 值在转换为<code>&#39;MET&#39;</code>时区时是相同的。对于给定的<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html">TIMESTAMP</a>列查询，此现象可能导致不同的结果，具体取决于优化器是否使用索引来执行查询。</p>
<p>假设查询使用<code>WHERE</code>子句从前面显示的 table 中选择值，以在<code>ts</code>列中搜索单个特定值，例如用户提供的时间戳 Literals：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SELECT ts FROM tstable
WHERE ts <span class="token operator">=</span> <span class="token string">'literal'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>进一步假设查询在以下条件下执行：</p>
<ul>
<li>会话时区不是 UTC，并且具有 DST 偏移。例如：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SET time_zone <span class="token operator">=</span> <span class="token string">'MET'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>由于 DST 偏移，在<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/datetime.html">TIMESTAMP</a>列中存储的唯一 UTC 值在会话时区中不是唯一的。 (前面显示的示例说明了这种情况的发生.)</li>
<li>该查询指定了在会话时区中 ImportingDST 小时内的搜索值。</li>
</ul>
<p>在这种情况下，对于未构建索引和构建索引的查找，<code>WHERE</code>子句中的比较以不同的方式发生，并导致不同的结果：</p>
<ul>
<li>如果没有索引或优化器无法使用它，则会在会话时区中进行比较。优化器执行 table 扫描，其中检索每个<code>ts</code>列值，将其从 UTC 转换为会话时区，并将其与搜索值(也在会话时区中解释)进行比较：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SELECT ts FROM tstable
       WHERE ts <span class="token operator">=</span> <span class="token string">'2018-10-28 02:30:00'</span><span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> ts                  <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
+---------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于已存储的<code>ts</code>值已转换为会话时区，因此查询有可能返回两个时间戳值，这些时间戳值与 UTC 值不同，但在会话时区中相等：更改时钟时，在 DST 移位之前出现的一个值，以及 DST 移位后出现的一个值。</p>
<ul>
<li>如果有可用的索引，则以 UTC 进行比较。优化器执行索引扫描，首先将搜索值从会话时区转换为 UTC，然后将结果与 UTC 索引条目进行比较：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> ALTER TABLE tstable ADD INDEX <span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
mysql<span class="token operator">></span> SELECT ts FROM tstable
       WHERE ts <span class="token operator">=</span> <span class="token string">'2018-10-28 02:30:00'</span><span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> ts                  <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
+---------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这种情况下，(转换后的)搜索值仅与索引条目匹配，并且由于不同存储的 UTC 值的索引条目也不同，因此搜索值只能匹配其中之一。</p>
<p>由于针对非索引和索引查找的优化器操作不同，因此在每种情况下查询都会产生不同的结果。非索引查找的结果将返回在会话时区中匹配的所有值。索引查找不能这样做：</p>
<ul>
<li>它在仅了解 UTC 值的存储引擎内执行。</li>
<li>对于 Map 到相同 UTC 值的两个不同的会话时区值，索引查找仅匹配相应的 UTC 索引条目，并且仅返回单行。</li>
</ul>
<p>在前面的讨论中，存储在<code>tstable</code>中的数据集恰好由不同的 UTC 值组成。在这种情况下，所示形式的所有使用索引的查询最多匹配一个索引条目。</p>
<p>如果索引不是<code>UNIQUE</code>，则 table(和索引)可以存储给定 UTC 值的多个实例。例如，<code>ts</code>列可能包含多个 UTC 值<code>&#39;2018-10-28 00:30:00&#39;</code>的实例。在这种情况下，使用索引的查询将返回它们中的每一个(在结果集中转换为 MET 值<code>&#39;2018-10-28 02:30:00&#39;</code>)。仍然使用索引的查询将转换后的搜索值与 UTC 索引条目中的单个值进行匹配，而不是将在会话时区中转换为搜索值的多个 UTC 值进行匹配。</p>
<p>如果返回在会话时区中匹配的所有<code>ts</code>值很重要，解决方法是禁止使用带有<code>IGNORE INDEX</code>提示的索引：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SELECT ts FROM tstable
       IGNORE INDEX <span class="token punctuation">(</span>ts<span class="token punctuation">)</span>
       WHERE ts <span class="token operator">=</span> <span class="token string">'2018-10-28 02:30:00'</span><span class="token punctuation">;</span>
+---------------------+
<span class="token operator">|</span> ts                  <span class="token operator">|</span>
+---------------------+
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2018</span>-10-28 02:30:00 <span class="token operator">|</span>
+---------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在其他情况下，例如使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/date-and-time-functions.html#function_from-unixtime">FROM_UNIXTIME()</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/date-and-time-functions.html#function_unix-timestamp">UNIX_TIMESTAMP()</a>函数执行的转换，在两个方向上也存在相同的缺少时空转换的双向 Map。</p>
<h1 id="4、优化数据结构"><a href="#4、优化数据结构" class="headerlink" title="4、优化数据结构"></a>4、优化数据结构</h1><h2 id="4-1、优化数据大小"><a href="#4-1、优化数据大小" class="headerlink" title="4.1、优化数据大小"></a>4.1、优化数据大小</h2><p>设计 table 以最小化它们在磁盘上的空间。通过减少写入磁盘和从磁盘读取的数据量，这可以带来巨大的改进。较小的 table 通常需要较少的主内存，而在查询执行期间对它们的内容进行有效处理时。table 数据的任何空间减少都会导致索引变小，从而可以更快地处理索引。</p>
<p>MySQL 支持许多不同的存储引擎(table 类型)和行格式。对于每个 table，您可以决定使用哪种存储和索引方法。为您的应用程序选择适当的 table 格式可以大大提高性能。</p>
<p>可以提高 table 的性能，并最大程度地减少存储空间的方法如下：</p>
<ul>
<li>表列</li>
<li>行格式</li>
<li>索引</li>
<li>join连接</li>
<li>正常化</li>
</ul>
<h3 id="4-1-1、表列"><a href="#4-1-1、表列" class="headerlink" title="4.1.1、表列"></a>4.1.1、表列</h3><ol>
<li>尽可能使用最有效(最小)的数据类型。</li>
<li>尽可能将列声明为<code>NOT NULL</code>。</li>
</ol>
<h3 id="4-1-2、行格式"><a href="#4-1-2、行格式" class="headerlink" title="4.1.2、行格式"></a>4.1.2、行格式</h3><p>默认情况下，<code>InnoDB</code>table 是使用<code>DYNAMIC</code>行格式创建。要使用<code>DYNAMIC</code>以外的行格式，请配置<code>innodb_default_row_format</code>，或在<code>CREATE TABLE</code>或<code>ALTER TABLE</code>语句中显式指定<code>ROW_FORMAT</code>选项。</p>
<p>紧凑的行格式系列(包括<code>COMPACT</code>，<code>DYNAMIC</code>和<code>COMPRESSED</code>)以增加某些操作的 CPU 使用为代价，减少了行存储空间。如果您的工作量是典型的工作量，受缓存命中率和磁盘速度的限制，则可能会更快。如果在极少数情况下受 CPU 速度的限制，则速度可能会更慢。</p>
<p>当使用可变长度字符集(例如<code>utf8mb3</code>或<code>utf8mb4</code>)时，紧凑的行格式系列还可以优化<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html">CHAR</a>列的存储。</p>
<h3 id="4-1-3、索引"><a href="#4-1-3、索引" class="headerlink" title="4.1.3、索引"></a>4.1.3、索引</h3><ol>
<li>表主索引应尽量短；</li>
<li>仅创建需要提高查询性能的索引；</li>
<li>充分利用最左前缀匹配；</li>
</ol>
<h3 id="4-1-4、连接"><a href="#4-1-4、连接" class="headerlink" title="4.1.4、连接"></a>4.1.4、连接</h3><ol>
<li>在某些情况下，将经常扫描的 table 分成两部分可能会有所帮助。</li>
<li>在具有相同数据类型的不同 table 中声明具有相同信息的列，以加快基于相应列的联接。</li>
<li>使列名保持简单，以便您可以在不同的 table 中使用相同的名称并简化联接查询。</li>
</ol>
<h3 id="4-1-5、其它建议"><a href="#4-1-5、其它建议" class="headerlink" title="4.1.5、其它建议"></a>4.1.5、其它建议</h3><ol>
<li>通常，请尝试使所有数据保持非冗余(请注意数据库理论中称为第三范式的内容)。不必重复冗长的值(例如名称和地址)，而是给它们分配唯一的 ID，在多个较小的 table 中根据需要重复这些 ID，然后通过引用 join 子句中的 ID 在查询中联接这些 table。</li>
<li>如果速度比磁盘空间和保留多个数据副本的维护成本更为重要，例如在商业智能场景中，其中您分析大型 table 中的所有数据，则可以放宽规范化规则，复制信息或创建汇总 table 以提高速度。</li>
</ol>
<h2 id="4-2、优化数据类型"><a href="#4-2、优化数据类型" class="headerlink" title="4.2、优化数据类型"></a>4.2、优化数据类型</h2><h3 id="4-2-1、优化数值类型"><a href="#4-2-1、优化数值类型" class="headerlink" title="4.2.1、优化数值类型"></a>4.2.1、优化数值类型</h3><p>于可以 table 示为字符串或数字的唯一 ID 或其他值，与字符串列相比，首选数字列。由于大数值可以比相应字符串存储在更少的字节中，因此它传输速度更快，并且占用更少的内存来进行比较。</p>
<h3 id="4-2-2、优化字符和字符串类型"><a href="#4-2-2、优化字符和字符串类型" class="headerlink" title="4.2.2、优化字符和字符串类型"></a>4.2.2、优化字符和字符串类型</h3><ol>
<li>当您不需要特定于语言的排序规则功能时，请使用二进制排序规则 Sequences 进行快速比较和排序操作。您可以使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/cast-functions.html#operator_binary">BINARY</a>运算符在特定查询中使用二进制排序规则。</li>
<li>比较来自不同列的值时，请尽可能声明具有相同字符集和排序规则的那些列，以避免在运行查询时进行字符串转换。</li>
<li>对于小于 8KB 的列值，请使用二进制<code>VARCHAR</code>而不是<code>BLOB</code>。 <code>GROUP BY</code>和<code>ORDER BY</code>子句可以生成临时 table，并且如果原始 table 不包含任何<code>BLOB</code>列，则这些临时 table 可以使用<code>MEMORY</code>存储引擎。</li>
<li>如果 table 包含名称和地址之类的字符串列，但是许多查询未检索到这些列，请考虑将字符串列拆分为单独的 table，并在必要时使用带有外键的联接查询。当 MySQL 从一行中检索任何值时，它将读取一个包含该行所有列(可能还有其他相邻行)的数据块。保持每行较小，仅使用最常使用的列，可使更多行适合每个数据块。这样的紧凑 table 减少了常见查询的磁盘 I&#x2F;O 和内存使用量。</li>
<li>当您将随机生成的值用作<code>InnoDB</code>table 中的主键时，请尽可能在其前面加上一个升值，例如当前日期和时间。当连续的主值在物理上彼此靠近存储时，<code>InnoDB</code>可以更快地插入和检索它们。</li>
</ol>
<h3 id="4-2-3、优化BLOB类型"><a href="#4-2-3、优化BLOB类型" class="headerlink" title="4.2.3、优化BLOB类型"></a>4.2.3、优化BLOB类型</h3><ol>
<li>当存储包含文本数据的大 blob 时，请考虑首先对其进行压缩。当整个 table 由<code>InnoDB</code>或<code>MyISAM</code>压缩时，请勿使用此技术。</li>
<li>对于具有多个列的 table，为了减少不使用 BLOB 列的查询的内存需求，请考虑将 BLOB 列拆分为一个单独的 table，并在需要时使用联接查询对其进行引用。</li>
<li>由于检索和显示 BLOB 值的性能要求可能与其他数据类型完全不同，因此可以将特定于 BLOB 的 table 放在不同的存储设备上，甚至放在单独的数据库实例上。例如，要检索 BLOB，可能需要读取较大的 Sequences 磁盘，这比<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/glossary.html#glos_ssd">SSD device</a>更适合传统硬盘驱动器。</li>
<li>您可以将列值的哈希存储在单独的列中，对该列进行索引并在查询中测试该哈希值，而不是针对非常长的文本字符串测试是否相等。</li>
</ol>
<h2 id="4-3、优化多表"><a href="#4-3、优化多表" class="headerlink" title="4.3、优化多表"></a>4.3、优化多表</h2><h3 id="4-3-1、如何打开和关闭table"><a href="#4-3-1、如何打开和关闭table" class="headerlink" title="4.3.1、如何打开和关闭table"></a>4.3.1、如何打开和关闭table</h3><p>当执行<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqladmin.html">mysqladmin status</a>命令时，您应该看到类似以下的内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Uptime: <span class="token number">426</span> Running threads: <span class="token number">1</span> Questions: <span class="token number">11082</span>
Reloads: <span class="token number">1</span> Open tables: <span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果 table 少于 12 个，则<code>Open tables</code>的值 12 可能会令人困惑。</p>
<p>MySQL 是多线程的，因此可能有许多 Client 端同时为给定 table 发出查询。为了最大程度地减少同一张 table 上具有不同状态的多个 Client 端会话的问题，每个并发会话会独立打开该 table。这将使用额外的内存，但通常可以提高性能。对于<code>MyISAM</code>table，每个打开 table 的 Client 端的数据文件都需要一个额外的文件 Descriptors。 (相比之下，索引文件 Descriptors 在所有会话之间共享.)</p>
<p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_connections">max_connections</a>系统变量影响服务器保持打开状态的最大文件数。如果增加这两个值中的一个或两个，则可能会遇到 os 对打开文件 Descriptors 的每个进程数施加的限制。许多方法允许您增加打开文件的限制，尽管方法因系统而异。请查阅您的 os 文档，以确定是否可以增加限制以及如何增加限制。</p>
<p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>与<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_connections">max_connections</a>相关。例如，对于 200 个并发运行的连接，指定的 table 缓存大小至少为<code>200 * N</code>，其中* <code>N</code> *是您执行的任何查询中每个联接的最大 table 数。您还必须为临时 table 和文件保留一些额外的文件 Descriptors。</p>
<p>确保您的 os 可以处理<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>设置所隐含的打开文件 Descriptors 的数量。如果<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>设置得太高，MySQL 可能会用完文件 Descriptors，并 table 现出诸如拒绝连接或无法执行查询之类的症状。</p>
<p>还应考虑到<code>MyISAM</code>存储引擎为每个唯一的打开 table 都需要两个文件 Descriptors。对于<code>MyISAM</code>分区 table，打开的 table 的每个分区都需要两个文件 Descriptors。 (<code>MyISAM</code>打开分区 table 时，无论是否实际使用给定的分区，它都会打开该 table 的每个分区.请参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/partitioning-limitations.html#partitioning-limitations-myisam-file-descriptors">MyISAM 和分区文件 Descriptors 的用法</a>。)要增加可用于 MySQL 的文件 Descriptors 的数量，请设置<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_open_files_limit">open_files_limit</a>系统变量。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/not-enough-file-handles.html">B.4.2.17 节，“找不到文件和类似错误”</a>。</p>
<p>打开 table 的缓存保持在<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>个条目的级别。服务器在启动时自动调整缓存大小。要显式设置大小，请在启动时设置<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>系统变量。 MySQL 可能会临时打开更多 table 来执行查询，如本节后面所述。</p>
<p>在以下情况下，MySQL 关闭未使用的 table 并将其从 table 缓存中删除：</p>
<ul>
<li>当缓存已满并且线程尝试打开不在缓存中的 table 时。</li>
<li>当高速缓存包含多个<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>个条目并且高速缓存中的 table 不再被任何线程使用时。</li>
<li>当进行 table 刷新操作时。当有人发出<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-tables">FLUSH TABLES</a>语句或执行<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqladmin.html">mysqladmin flush-tables</a>或<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqladmin.html">mysqladmin refresh</a>命令时，就会发生这种情况。</li>
</ul>
<p>当 table 高速缓存填满时，服务器将使用以下过程找到要使用的高速缓存条目：</p>
<ul>
<li>从最近最少使用的 table 开始，释放当前未使用的 table。</li>
<li>如果必须打开一个新 table，但是缓存已满并且无法释放任何 table，则可以根据需要临时扩展缓存。当缓存处于临时扩展状态并且 table 从使用状态变为未使用状态时，table 将关闭并从缓存中释放。</li>
</ul>
<p>如果要使用<code>HANDLER tbl_name OPEN</code>语句打开 table，则会为该线程分配专用的 table 对象。该 table 对象不与其他线程共享，并且在线程调用<code>HANDLER tbl_name CLOSE</code>或线程终止之前不会关闭。发生这种情况时，会将 table 放回 table 缓存中(如果缓存未满)。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/handler.html">第 13.2.4 节“ HANDLER 语句”</a>。</p>
<p>要确定 table 缓存是否太小，请检查<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Opened_tables">Opened_tables</a> status 变量，该变量指示自服务器启动以来 table 打开操作的数量：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SHOW GLOBAL STATUS LIKE <span class="token string">'Opened_tables'</span><span class="token punctuation">;</span>
+---------------+-------+
<span class="token operator">|</span> Variable_name <span class="token operator">|</span> Value <span class="token operator">|</span>
+---------------+-------+
<span class="token operator">|</span> Opened_tables <span class="token operator">|</span> <span class="token number">2741</span>  <span class="token operator">|</span>
+---------------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果该值很大或迅速增加，即使您没有发出很多<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/flush.html#flush-tables">FLUSH TABLES</a>语句，也要在服务器启动时增加<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_table_open_cache">table_open_cache</a>值。</p>
<h3 id="4-3-2、一个数据库中创建多table的缺点"><a href="#4-3-2、一个数据库中创建多table的缺点" class="headerlink" title="4.3.2、一个数据库中创建多table的缺点"></a>4.3.2、一个数据库中创建多table的缺点</h3><p>如果同一数据库目录中有许多<code>MyISAM</code>table，则打开，关闭和创建操作的速度很慢。如果在许多不同的 table 上执行<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/select.html">SELECT</a>语句，则 table 高速缓存已满时会产生一些开销，因为对于必须打开的每个 table，必须关闭另一个 table。您可以通过增加 table 缓存中允许的条目数来减少此开销。</p>
<h2 id="4-4、内部临时表的使用"><a href="#4-4、内部临时表的使用" class="headerlink" title="4.4、内部临时表的使用"></a>4.4、内部临时表的使用</h2><p>服务器在以下条件下创建临时 table：</p>
<ul>
<li>评估【UNION语句】，但稍后会有一些 exception。</li>
<li>评估某些视图，例如使用<code>TEMPTABLE</code>算法，UNION或聚合视图。</li>
<li>派生 table 的评估。</li>
<li>为子查询或半联接实现创建的 table。</li>
<li>评估包含<code>ORDER BY</code>子句和不同的<code>GROUP BY</code>子句的语句，或者<code>ORDER BY</code>或<code>GROUP BY</code>包含来自联接队列中第一个 table 以外的 table 的列的语句。</li>
<li>对<code>DISTINCT</code>和<code>ORDER BY</code>相结合的评估可能需要一个临时 table。</li>
<li>对于使用<code>SQL_SMALL_RESULT</code>修饰符的查询，MySQL 使用内存中临时 table，除非查询还包含需要磁盘存储的元素(稍后描述)。</li>
<li>为了评估从同一 table 中选择并插入到该 table 中的【插入…选择】语句，MySQL 创建一个内部临时 table 来保存SELECT中的行，然后将这些行插入目标 table 中。</li>
<li>评估多 table UPDATE语句。</li>
<li>评估【GROUP_CONCAT()】或【COUNT(DISTINCT) 表达式。</li>
</ul>
<p>要确定语句是否需要临时 table，请使用【EXPLAIN】并检查<code>Extra</code>列以查看其是否 table 示<code>Using temporary</code>。对于派生的或物化的临时 table，<code>EXPLAIN</code>不一定会说<code>Using temporary</code>。</p>
<p>某些查询条件阻止使用内存中的临时 table，在这种情况下，服务器将使用磁盘上的 table 代替：</p>
<ul>
<li>table 格中存在BLOB或TEXT列。这包括具有字符串值的用户定义变量，因为它们分别被视为 bob和text列，具体取决于它们的值是二进制字符串还是非二进制字符串。</li>
<li>如果使用了UNION或UNION ALL，则SELECT列 table 中存在任何最大长度大于 512(字符串为二进制字符串，非二进制为字符)的字符串列。</li>
<li>SHOW COLUMNS和DESCRIBE语句使用<code>BLOB</code>作为某些列的类型，因此用于结果的临时 table 是磁盘上的 table。</li>
</ul>
<p>这些条件使<code>UNION</code>可以在没有临时 table 的情况下进行评估：</p>
<ul>
<li>联合是<code>UNION ALL</code>，而不是<code>UNION</code>或<code>UNION DISTINCT</code>。</li>
<li>没有全局<code>ORDER BY</code>子句。</li>
<li>联合不是<code>&#123;INSERT | REPLACE&#125; ... SELECT ...</code>语句的顶级查询块。</li>
</ul>
<h3 id="4-4-1、内部临时表-存储引擎"><a href="#4-4-1、内部临时表-存储引擎" class="headerlink" title="4.4.1、内部临时表 存储引擎"></a>4.4.1、内部临时表 存储引擎</h3><p>内部临时 table 可以保存在内存中，并由<code>MEMORY</code>存储引擎处理，或者由<code>InnoDB</code>或<code>MyISAM</code>存储引擎存储在磁盘上。</p>
<p>如果内部临时 table 被创建为内存 table，但又太大了，MySQL 会自动将其转换为磁盘 table。内存中临时 table 的最大大小由<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_tmp_table_size">tmp_table_size</a>或<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size">max_heap_table_size</a>值定义，以较小者为准。这与使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/create-table.html">CREATE TABLE</a>显式创建的<code>MEMORY</code>table 不同。对于此类 table，只有<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size">max_heap_table_size</a>变量确定 table 可以增长到多大，并且不转换为磁盘格式。</p>
<p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_internal_tmp_disk_storage_engine">internal_tmp_disk_storage_engine</a>变量定义服务器用来 Management 磁盘内部临时 table 的存储引擎。允许的值为<code>INNODB</code>(默认值)和<code>MYISAM</code>。</p>
<p>当在内存或磁盘中创建内部临时 table 时，服务器将使<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Created_tmp_tables">Created_tmp_tables</a>值递增。在磁盘上创建内部临时 table 时，服务器将使<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-status-variables.html#statvar_Created_tmp_disk_tables">Created_tmp_disk_tables</a>值递增。如果在磁盘上创建了太多内部临时 table，请考虑增加<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_tmp_table_size">tmp_table_size</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size">max_heap_table_size</a>设置。</p>
<h3 id="4-4-2、内部临时表-存储格式"><a href="#4-4-2、内部临时表-存储格式" class="headerlink" title="4.4.2、内部临时表 存储格式"></a>4.4.2、内部临时表 存储格式</h3><p>内存中的临时 table 由<code>MEMORY</code>存储引擎 Management，该引擎使用固定长度的行格式。 <code>VARCHAR</code>和<code>VARBINARY</code>列值被填充为最大列长度，实际上将它们存储为<code>CHAR</code>和<code>BINARY</code>列。</p>
<p>磁盘上的临时 table 由<code>InnoDB</code>或<code>MyISAM</code>存储引擎(取决于<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_internal_tmp_disk_storage_engine">internal_tmp_disk_storage_engine</a>设置)Management。两个引擎都使用动态宽度行格式存储临时 table。列仅占用所需的存储空间，与使用固定长度行的磁盘 table 相比，这减少了磁盘 I&#x2F;O，空间需求和处理时间。</p>
<p>对于最初在内存中创建内部临时 table 然后将其转换为磁盘上 table 的语句，跳过转换步骤并在磁盘上开始创建 table 可能会获得更好的性能。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_big_tables">big_tables</a>变量可用于强制内部临时 table 进行磁盘存储。</p>
<h2 id="4-5、数据库和表数量限制"><a href="#4-5、数据库和表数量限制" class="headerlink" title="4.5、数据库和表数量限制"></a>4.5、数据库和表数量限制</h2><p>MySQL 对数据库的数量没有限制。基础文件系统可能对目录数有限制。</p>
<p>MySQL 对 table 的数量没有限制。基础文件系统可能会对 table 示 table 的文件数量有所限制。各个存储引擎可能会强加特定于引擎的约束。 <code>InnoDB</code>允许多达 40 亿张表。</p>
<h2 id="4-6、表格大小限制"><a href="#4-6、表格大小限制" class="headerlink" title="4.6、表格大小限制"></a>4.6、表格大小限制</h2><p>MySQL 数据库的有效最大 table 大小通常由 os 对文件大小的限制来确定，而不是由 MySQL 内部限制来确定。有关 os 文件大小限制的最新信息，请参阅特定于您的 os 的文档。</p>
<p>Windows 用户，请注意 FAT 和 VFAT(FAT32)被认为不适合与 MySQL 一起用于生产。请改用 NTFS。</p>
<p>如果遇到全 table 错误，则可能由于多种原因导致它发生：</p>
<ul>
<li>磁盘可能已满。</li>
<li>您正在使用<code>InnoDB</code>table，并且<code>InnoDB</code>table 空间文件中的空间已用完。最大 table 空间大小也是 table 的最大大小。有关 table 空间大小的限制。</li>
</ul>
<p>通常，对于大于 1TB 的 table，建议将 table 划分为多个 table 空间文件。</p>
<ul>
<li>您已达到 os 文件大小限制。例如，您正在 os 上使用<code>MyISAM</code>table，该 table 仅支持最大 2GB 的文件，而数据文件或索引文件已达到此限制。</li>
<li>您正在使用<code>MyISAM</code>table，并且该 table 所需的空间超出了内部指针大小所允许的空间。 <code>MyISAM</code>允许数据和索引文件默认增加到 256TB，但此限制可以更改为最大允许大小 65,536TB(2567-1 字节)。</li>
</ul>
<p>解决<code>MyISAM</code>个 table 的文件大小限制的其他方法如下：</p>
<ul>
<li>如果您的大 table 是只读的，则可以使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisampack.html">myisampack</a>对其进行压缩。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisampack.html">myisampack</a>通常会将 table 压缩至少 50％，因此实际上您可以拥有更大的 table。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisampack.html">myisampack</a>还可以将多个 table 合并为一个 table。<ul>
<li>MySQL 包括一个<code>MERGE</code>库，使您能够处理与单个<code>MERGE</code>table 具有相同结构的<code>MyISAM</code>table 的集合。</li>
</ul>
</li>
<li>您正在使用<code>MEMORY</code>(<code>HEAP</code>)存储引擎；在这种情况下，您需要增加<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/server-system-variables.html#sysvar_max_heap_table_size">max_heap_table_size</a>系统变量的值。</li>
</ul>
<h2 id="4-7、表列数和行大小的限制"><a href="#4-7、表列数和行大小的限制" class="headerlink" title="4.7、表列数和行大小的限制"></a>4.7、表列数和行大小的限制</h2><h3 id="4-7-1、列数限制"><a href="#4-7-1、列数限制" class="headerlink" title="4.7.1、列数限制"></a>4.7.1、列数限制</h3><p>MySQL 对每个 table 有 4096 列的硬限制，但是对于给定的 table，有效最大值可能会更少。确切的列限制取决于几个因素：</p>
<ul>
<li>一个 table 的最大行大小限制了列的数量(可能还有大小)，因为所有列的总长度不能超过该大小。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/column-count-limit.html#row-size-limits">行大小限制</a>。</li>
<li>单个列的存储要求限制了给定最大行大小内的列数。某些数据类型的存储要求取决于存储引擎，存储格式和字符集等因素。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/storage-requirements.html">第 11.7 节“数据类型存储要求”</a>。</li>
<li>存储引擎可能会施加其他限制 table 列计数的限制。例如，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html">InnoDB</a>每个 table 的限制为 1017 列。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-limits.html">第 14.23 节“ InnoDB 限制”</a>。有关其他存储引擎的信息，请参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/storage-engines.html">第 15 章，备用存储引擎</a>。</li>
<li>每个 table 都有一个<code>.frm</code>文件，其中包含 table 定义。该定义以可能影响 table 中允许的列数的方式影响此文件的内容。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/create-table-files.html#limits-frm-file">.frm 文件结构施加的限制</a>。</li>
</ul>
<h3 id="4-7-2、行大小限制"><a href="#4-7-2、行大小限制" class="headerlink" title="4.7.2、行大小限制"></a>4.7.2、行大小限制</h3><p>给定 table 的最大行大小由几个因素决定：</p>
<ul>
<li>MySQLtable 的内部 table 示具有 65,535 字节的最大行大小限制，即使存储引擎能够支持更大的行也是如此。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">BLOB</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">TEXT</a>列仅占行大小限制的 9 到 12 个字节，因为它们的内容与其余行分开存储。</li>
<li><code>InnoDB</code>table 的最大行大小适用于数据库页面中本地存储的数据，对于 4KB，8KB，16KB 和 32KB <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-parameters.html#sysvar_innodb_page_size">innodb_page_size</a>设置，该行的最大行大小略小于一半。例如，对于默认的 16KB <code>InnoDB</code>页面大小，最大行大小略小于 8KB。对于 64KB 页面，最大行大小略小于 16KB。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-limits.html">第 14.23 节“ InnoDB 限制”</a>。</li>
</ul>
<p>如果包含<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/glossary.html#glos_variable_length_type">variable-length columns</a>的行超过<code>InnoDB</code>的最大行大小，则<code>InnoDB</code>选择可变长度的列用于外部页外存储，直到该行适合<code>InnoDB</code>行大小的限制。对于行外存储的变长列，本地存储的数据量因行格式而异。</p>
<h4 id="4-7-2-1、行大小限制测试示例"><a href="#4-7-2-1、行大小限制测试示例" class="headerlink" title="4.7.2.1、行大小限制测试示例"></a>4.7.2.1、行大小限制测试示例</h4><ul>
<li>以下<code>InnoDB</code>和<code>MyISAM</code>示例演示了 MySQL 最大行大小限制为 65,535 字节。不管存储引擎如何，都会强制执行该限制，即使存储引擎可能能够支持更大的行。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t <span class="token punctuation">(</span>a VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, b VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       c VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, d VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, e VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       f VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, g VARCHAR<span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">))</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB CHARACTER SET latin1<span class="token punctuation">;</span>
ERROR <span class="token number">1118</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Row size too large. The maximum row size <span class="token keyword">for</span> the used
table type, not counting BLOBs, is <span class="token number">65535</span>. This includes storage overhead,
check the manual. You have to change some columns to TEXT or BLOBs
mysql<span class="token operator">></span> CREATE TABLE t <span class="token punctuation">(</span>a VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, b VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       c VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, d VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, e VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       f VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, g VARCHAR<span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">))</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>MyISAM CHARACTER SET latin1<span class="token punctuation">;</span>
ERROR <span class="token number">1118</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Row size too large. The maximum row size <span class="token keyword">for</span> the used
table type, not counting BLOBs, is <span class="token number">65535</span>. This includes storage overhead,
check the manual. You have to change some columns to TEXT or BLOBs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在下面的<code>MyISAM</code>示例中，将列更改为<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">TEXT</a>可以避免 65,535 字节的行大小限制，并允许操作成功，因为<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">BLOB</a>和<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">TEXT</a>列仅对行大小贡献 9 至 12 个字节。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t <span class="token punctuation">(</span>a VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, b VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       c VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, d VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, e VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       f VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, g TEXT<span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">))</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>MyISAM CHARACTER SET latin1<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于<code>InnoDB</code>table，该操作成功，因为将列更改为<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/blob.html">TEXT</a>可以避免 MySQL 65,535 字节的行大小限制，而<code>InnoDB</code>可变长度列的页外存储可以避免<code>InnoDB</code>行大小限制。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t <span class="token punctuation">(</span>a VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, b VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       c VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, d VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, e VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>,
       f VARCHAR<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>, g TEXT<span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">))</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB CHARACTER SET latin1<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>可变长度列的存储包括长度字节，该长度字节计入行大小。例如，<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/char.html">VARCHAR(255)字符集 utf8mb3</a>列占用两个字节来存储值的长度，因此每个值最多可以占用 767 个字节。</li>
</ul>
<p>创建 table<code>t1</code>的语句成功，因为这些列需要 32,765 2 字节和 32,766 2 字节，这在最大行大小 65,535 字节之内：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t1
       <span class="token punctuation">(</span>c1 VARCHAR<span class="token punctuation">(</span><span class="token number">32765</span><span class="token punctuation">)</span> NOT NULL, c2 VARCHAR<span class="token punctuation">(</span><span class="token number">32766</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">)</span>
       ENGINE <span class="token operator">=</span> InnoDB CHARACTER SET latin1<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建 table<code>t2</code>的语句失败，因为尽管列长度在最大长度 65,535 字节以内，但仍需要两个额外的字节来记录该长度，这会导致行大小超过 65,535 字节：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t2
       <span class="token punctuation">(</span>c1 VARCHAR<span class="token punctuation">(</span><span class="token number">65535</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">)</span>
       ENGINE <span class="token operator">=</span> InnoDB CHARACTER SET latin1<span class="token punctuation">;</span>
ERROR <span class="token number">1118</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Row size too large. The maximum row size <span class="token keyword">for</span> the used
table type, not counting BLOBs, is <span class="token number">65535</span>. This includes storage overhead,
check the manual. You have to change some columns to TEXT or BLOBs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将列长度减少到 65,533 或更短，可以使语句成功。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t2
       <span class="token punctuation">(</span>c1 VARCHAR<span class="token punctuation">(</span><span class="token number">65533</span><span class="token punctuation">)</span> NOT NULL<span class="token punctuation">)</span>
       ENGINE <span class="token operator">=</span> InnoDB CHARACTER SET latin1<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>对于<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-storage-engine.html">MyISAM</a>个 table，<code>NULL</code>列在行中需要额外的空间以记录其值是否为<code>NULL</code>。每个<code>NULL</code>列都多加一位，四舍五入到最接近的字节。</li>
</ul>
<p>创建 table<code>t3</code>的语句失败，因为<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-storage-engine.html">MyISAM</a>除了可变长度的列长度字节所需的空间外，还需要<code>NULL</code>列的空间，从而导致行大小超过 65,535 字节：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t3
       <span class="token punctuation">(</span>c1 VARCHAR<span class="token punctuation">(</span><span class="token number">32765</span><span class="token punctuation">)</span> NULL, c2 VARCHAR<span class="token punctuation">(</span><span class="token number">32766</span><span class="token punctuation">)</span> NULL<span class="token punctuation">)</span>
       ENGINE <span class="token operator">=</span> MyISAM CHARACTER SET latin1<span class="token punctuation">;</span>
ERROR <span class="token number">1118</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Row size too large. The maximum row size <span class="token keyword">for</span> the used
table type, not counting BLOBs, is <span class="token number">65535</span>. This includes storage overhead,
check the manual. You have to change some columns to TEXT or BLOBs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有关<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-storage-engine.html">InnoDB</a> <code>NULL</code>列存储的信息，请参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-row-format.html">第 14.11 节“ InnoDB 行格式”</a>。</p>
<ul>
<li><code>InnoDB</code>将 4KB，8KB，16KB 和 32KB <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-parameters.html#sysvar_innodb_page_size">innodb_page_size</a>设置的行大小(用于数据库页面中本地存储的数据)限制为略小于数据库页面的一半，而对于 64KB 页面，则限制为小于 16KB。</li>
</ul>
<p>创建 table<code>t4</code>的语句失败，因为定义的列超出了 16KB <code>InnoDB</code>页的行大小限制。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> CREATE TABLE t4 <span class="token punctuation">(</span>
       c1 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c2 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c3 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c4 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c5 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c6 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c7 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c8 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c9 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c10 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c11 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c12 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c13 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c14 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c15 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c16 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c17 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c18 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c19 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c20 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c21 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c22 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c23 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c24 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c25 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c26 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c27 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c28 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c29 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c30 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,
       c31 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c32 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>,c33 CHAR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span> <span class="token assign-left variable">ENGINE</span><span class="token operator">=</span>InnoDB <span class="token assign-left variable">ROW_FORMAT</span><span class="token operator">=</span>COMPACT DEFAULT CHARSET latin1<span class="token punctuation">;</span>
ERROR <span class="token number">1118</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: Row size too large <span class="token punctuation">(</span><span class="token operator">></span> <span class="token number">8126</span><span class="token punctuation">)</span>. Changing some columns to TEXT or BLOB or using
<span class="token assign-left variable">ROW_FORMAT</span><span class="token operator">=</span>DYNAMIC or <span class="token assign-left variable">ROW_FORMAT</span><span class="token operator">=</span>COMPRESSED may help. In current row format, BLOB prefix of <span class="token number">768</span>
bytes is stored inline.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="5、优化InnoDB表"><a href="#5、优化InnoDB表" class="headerlink" title="5、优化InnoDB表"></a>5、优化InnoDB表</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-storage-layout.html">5.1 为 InnoDBtable 优化存储布局</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-transaction-management.html">5.2 优化 InnoDB 事务 Management</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-performance-ro-txn.html">5.3 优化 InnoDB 只读事务</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-logging.html">5.4 优化 InnoDB 重做日志</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-bulk-data-loading.html">5.5 InnoDBtable 的批量数据加载</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-queries.html">5.6 优化 InnoDB 查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-ddl-operations.html">5.7 优化 InnoDB DDL 操作</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-diskio.html">5.8 优化 InnoDB 磁盘 I&#x2F;O</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-configuration-variables.html">5.9 优化 InnoDB 配置变量</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-innodb-many-tables.html">5.10 为具有多个 table 的系统优化 InnoDB</a></li>
</ul>
<h1 id="6、优化MyISAM表"><a href="#6、优化MyISAM表" class="headerlink" title="6、优化MyISAM表"></a>6、优化MyISAM表</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-queries-myisam.html">6.1 优化 MyISAM 查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-myisam-bulk-data-loading.html">6.2 MyISAMtable 的批量数据加载</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/repair-table-optimization.html">6.3 优化 REPAIR TABLE 语句</a></li>
</ul>
<h1 id="7、优化内存表"><a href="#7、优化内存表" class="headerlink" title="7、优化内存表"></a>7、优化内存表</h1><p>考虑将<code>MEMORY</code>table 用于经常访问，只读或很少更新的非关键数据。在实际工作量下，将您的应用程序与等效的<code>InnoDB</code>或<code>MyISAM</code>table 进行基准测试，以确认任何额外的性能值得承担丢失数据的风险，或者值得在应用程序启动时从基于磁盘的 table 复制数据的开销。</p>
<p>为了使<code>MEMORY</code>table 具有最佳性能，请检查针对每个 table 的查询类型，并指定用于每个关联索引(B 树索引或哈希索引)的类型。在<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/create-index.html">CREATE INDEX</a>语句上，使用<code>USING BTREE</code>或<code>USING HASH</code>子句。对于通过<code>&gt;</code>或<code>BETWEEN</code>等运算符进行大于或小于比较的查询，B 树索引速度很快。哈希索引仅适用于通过<code>=</code>运算符查找单个值或通过<code>IN</code>运算符查找有限值的查询。</p>
<h1 id="8、查询执行计划"><a href="#8、查询执行计划" class="headerlink" title="8、查询执行计划"></a>8、查询执行计划</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/using-explain.html">8.1 使用 EXPLAIN 优化查询</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-output.html">8.2 EXPLAIN 输出格式</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-extended.html">8.3 扩展 EXPLAIN 输出格式</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/explain-for-connection.html">8.4 获取命名连接的执行计划信息</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/estimating-performance.html">8.5 估算查询性能</a></li>
</ul>
<h1 id="9、查询优化器"><a href="#9、查询优化器" class="headerlink" title="9、查询优化器"></a>9、查询优化器</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/controlling-query-plan-evaluation.html">9.1 控制查询计划评估</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/switchable-optimizations.html">9.2 可切换的优化</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizer-hints.html">9.3 优化器提示</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/index-hints.html">9.4 索引提示</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/cost-model.html">9.5 优化器成本模型</a></li>
</ul>
<h1 id="10、缓存和缓冲"><a href="#10、缓存和缓冲" class="headerlink" title="10、缓存和缓冲"></a>10、缓存和缓冲</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-buffer-pool-optimization.html">10.1 InnoDB 缓冲池优化</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/myisam-key-cache.html">10.2 MyISAM 密钥缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/query-cache.html">10.3 MySQL 查询缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/statement-caching.html">10.4 缓存准备好的语句和存储的程序</a></li>
</ul>
<h1 id="11、优化锁定操作"><a href="#11、优化锁定操作" class="headerlink" title="11、优化锁定操作"></a>11、优化锁定操作</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/internal-locking.html">11.1 内部锁定方法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/table-locking.html">11.2table 锁定问题</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/concurrent-inserts.html">11.3 并发插入</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/metadata-locking.html">11.4 元数据锁定</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/external-locking.html">11.5 外部锁定</a></li>
</ul>
<h1 id="12、优化MySQL服务器"><a href="#12、优化MySQL服务器" class="headerlink" title="12、优化MySQL服务器"></a>12、优化MySQL服务器</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/system-optimization.html">12.1 系统因素</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/disk-issues.html">12.2 优化磁盘 I&#x2F;O</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/symbolic-links.html">12.3 使用符号链接</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/optimizing-memory.html">12.4 优化内存使用</a></li>
</ul>
<h1 id="13、评估效果"><a href="#13、评估效果" class="headerlink" title="13、评估效果"></a>13、评估效果</h1><h2 id="13-1、测量表达式和函数的速度"><a href="#13-1、测量表达式和函数的速度" class="headerlink" title="13.1、测量表达式和函数的速度"></a>13.1、测量表达式和函数的速度</h2><p>要测量特定 MySQLtable 达式或函数的速度，请使用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysql.html">mysql</a>Client 端程序调用<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/information-functions.html#function_benchmark">BENCHMARK()</a>函数。它的语法是<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/information-functions.html#function_benchmark">BENCHMARK(loop_count,expr)</a>。返回值始终为零，但是<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysql.html">mysql</a>打印一行，显示大约执行该语句所需的时间。例如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql<span class="token operator">></span> SELECT BENCHMARK<span class="token punctuation">(</span><span class="token number">1000000,1</span>+1<span class="token punctuation">)</span><span class="token punctuation">;</span>
+------------------------+
<span class="token operator">|</span> BENCHMARK<span class="token punctuation">(</span><span class="token number">1000000,1</span>+1<span class="token punctuation">)</span> <span class="token operator">|</span>
+------------------------+
<span class="token operator">|</span>                      <span class="token number">0</span> <span class="token operator">|</span>
+------------------------+
<span class="token number">1</span> row <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.32</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该结果是在奔腾 II 400MHz 系统上获得的。它显示 MySQL 在该系统上可以在 0.32 秒内执行 1,000,000 个简单加法 table 达式。</p>
<p>内置的 MySQL 函数通常经过高度优化，但可能会有一些 exception。 <a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/information-functions.html#function_benchmark">BENCHMARK()</a>是一个很好的工具，可以用来确定您的查询是否存在某些功能。</p>
<h2 id="13-2、使用自己的基准"><a href="#13-2、使用自己的基准" class="headerlink" title="13.2、使用自己的基准"></a>13.2、使用自己的基准</h2><p>对您的应用程序和数据库进行基准测试，以找出瓶颈所在。在解决了一个瓶颈之后(或通过将其替换为“虚拟”模块)，您可以 continue 确定下一个瓶颈。即使您的应用程序的总体性能目前可以接受，您至少也应该为每个瓶颈制定一个计划，并在有一天确实需要额外的性能时决定如何解决它。</p>
<p>免费的基准套件是<a target="_blank" rel="noopener" href="http://osdb.sourceforge.net/%E5%A4%84%E7%9A%84%E5%BC%80%E6%BA%90%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E5%87%86%E3%80%82">http://osdb.sourceforge.net/处的开源数据库基准。</a></p>
<p>仅当系统负载很重时才发生问题是很常见的。我们有许多 Client 在 Producing(经过测试)系统并遇到负载问题时与我们联系。在大多数情况下，性能问题可能是由于基本数据库设计问题(例如，table 扫描在高负载下效果不佳)或 os 或库问题引起的。在大多数情况下，如果系统尚未投入生产，这些问题将更容易解决。</p>
<p>为避免出现此类问题，请在可能的最坏负载下对整个应用程序进行基准测试：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqlslap.html">mysqlslap</a>程序对于模拟多个 Client 端同时发出查询所产生的高负载可能会有所帮助。参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysqlslap.html">第 4.5.8 节“ mysqlslap-一个负载仿真 Client 端”</a>。</li>
<li>您也可以尝试<a target="_blank" rel="noopener" href="https://launchpad.net/sysbench%E5%92%8Chttp://osdldbt.sourceforge.net/#dbt2%E6%8F%90%E4%BE%9B%E7%9A%84%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%E5%8C%85%EF%BC%8C%E4%BE%8B%E5%A6%82">https://launchpad.net/sysbench和http://osdldbt.sourceforge.net/#dbt2提供的基准测试包，例如</a> SysBench 和 DBT2.</li>
</ul>
<p>这些程序或软件包可以使系统崩溃，因此请确保仅在开发系统上使用它们。</p>
<h2 id="13-3、使用performance-schema"><a href="#13-3、使用performance-schema" class="headerlink" title="13.3、使用performance_schema"></a>13.3、使用performance_schema</h2><p>您可以查询<code>performance_schema</code>数据库中的 table 以查看有关服务器及其正在运行的应用程序的性能 Feature 的实时信息。有关详情，请参见<a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/performance-schema.html">MySQL 性能模式</a>。</p>
<h1 id="14、检测服务器线程-进程信息"><a href="#14、检测服务器线程-进程信息" class="headerlink" title="14、检测服务器线程&#x2F;进程信息"></a>14、检测服务器线程&#x2F;进程信息</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/processlist-access.html">14.1 访问进程列 table</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/thread-commands.html">14.2 线程命令值</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/general-thread-states.html">14.3 通用线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/query-cache-thread-states.html">14.4 查询缓存线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/source-thread-states.html">14.5 复制源线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/replica-io-thread-states.html">14.6 复制副本 I&#x2F;O 线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/replica-sql-thread-states.html">14.7 复制副本 SQL 线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/replica-connection-thread-states.html">14.8 复制副本连接线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/mysql-cluster-thread-states.html">14.9 NDB 群集线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/event-scheduler-thread-states.html">14.10 事件计划程序线程状态</a></li>
</ul>
<h1 id="XX查询优化"><a href="#XX查询优化" class="headerlink" title="XX查询优化"></a>XX查询优化</h1><h2 id="查询慢"><a href="#查询慢" class="headerlink" title="查询慢"></a>查询慢</h2><ol>
<li>网络</li>
<li>CPU</li>
<li>IO</li>
<li>上下文</li>
<li>系统调用</li>
<li>生成统计信息</li>
<li>锁等待时间</li>
</ol>
<h2 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h2><ol>
<li>是某些查询需要筛选大量数据<ol>
<li>判断 程序是否在检索大量超过需要的数据；</li>
<li>判断 mysql服务器层是否在分析大量超过需要的数据；</li>
</ol>
</li>
<li>是否向数据库请求了不需要的数据<ol>
<li>查询不需要的数据；</li>
<li>多表关联时返回全部列；</li>
<li>总是取全部列；</li>
<li>重复查询相同数据；</li>
</ol>
</li>
</ol>
<h2 id="执行过程优化"><a href="#执行过程优化" class="headerlink" title="执行过程优化"></a>执行过程优化</h2><h3 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h3><h3 id="查询优化处理"><a href="#查询优化处理" class="headerlink" title="查询优化处理"></a>查询优化处理</h3><h4 id="语法解析器"><a href="#语法解析器" class="headerlink" title="语法解析器"></a>语法解析器</h4><h4 id="查询优化器"><a href="#查询优化器" class="headerlink" title="查询优化器"></a>查询优化器</h4><ol>
<li>经过大量统计信息计算得出；</li>
<li>大多情况下，mysql会选择错误的执行计划；</li>
<li>优化器的优化策略；</li>
<li>优化器的优化类型；</li>
<li>关联查询；</li>
<li>排序优化；</li>
</ol>
<h2 id="优化特定类型的查询"><a href="#优化特定类型的查询" class="headerlink" title="优化特定类型的查询"></a>优化特定类型的查询</h2><h3 id="优化count查询"><a href="#优化count查询" class="headerlink" title="优化count查询"></a>优化count查询</h3><h3 id="优化关联查询"><a href="#优化关联查询" class="headerlink" title="优化关联查询"></a>优化关联查询</h3><h3 id="优化子查询"><a href="#优化子查询" class="headerlink" title="优化子查询"></a>优化子查询</h3><h3 id="优化group-by和distinct"><a href="#优化group-by和distinct" class="headerlink" title="优化group by和distinct"></a>优化group by和distinct</h3><h3 id="优化limit分页"><a href="#优化limit分页" class="headerlink" title="优化limit分页"></a>优化limit分页</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp e <span class="token keyword">join</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> eid <span class="token keyword">from</span> emp e2 <span class="token keyword">limit</span> <span class="token number">10000</span><span class="token punctuation">,</span><span class="token number">5</span>
<span class="token punctuation">)</span><span class="token keyword">where</span> e<span class="token punctuation">.</span>eid <span class="token operator">=</span> e2<span class="token punctuation">.</span>eid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="优化union查询"><a href="#优化union查询" class="headerlink" title="优化union查询"></a>优化union查询</h3><h3 id="使用自定义变量"><a href="#使用自定义变量" class="headerlink" title="使用自定义变量"></a>使用自定义变量</h3>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">豪哥</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://hshz21.gitee.io/2023/09/14/mysql-jing-tong-diao-you/">https://hshz21.gitee.io/2023/09/14/mysql-jing-tong-diao-you/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">豪哥</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MySQL/">
                                    <span class="chip bg-color">MySQL</span>
                                </a>
                            
                                <a href="/tags/MySQL%E8%B0%83%E4%BC%98/">
                                    <span class="chip bg-color">MySQL调优</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wxpay.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/09/14/mysql-jing-dian-sql-lian-xi-ti-zhi-leetcode-pian-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="MySQL系列-MySQL经典SQL练习题之Leetcode篇（一）">
                        
                        <span class="card-title">MySQL系列-MySQL经典SQL练习题之Leetcode篇（一）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-09-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MySQL/" class="post-category">
                                    MySQL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/SQL%E7%BB%83%E4%B9%A0/">
                        <span class="chip bg-color">SQL练习</span>
                    </a>
                    
                    <a href="/tags/MySQL%E7%BB%83%E4%B9%A0/">
                        <span class="chip bg-color">MySQL练习</span>
                    </a>
                    
                    <a href="/tags/LeetcodeSQL/">
                        <span class="chip bg-color">LeetcodeSQL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/09/14/mysql-huan-jing-da-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="MySQL系列-MySQL环境搭建">
                        
                        <span class="card-title">MySQL系列-MySQL环境搭建</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-09-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MySQL/" class="post-category">
                                    MySQL
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MySQL/">
                        <span class="chip bg-color">MySQL</span>
                    </a>
                    
                    <a href="/tags/MySQL%E7%8E%AF%E5%A2%83/">
                        <span class="chip bg-color">MySQL环境</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">豪哥</a>
            |&nbsp;Powered by&nbsp;<a href="https://github.com/lucky2shh" target="_blank">豪哥</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:3577293158@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=3577293158" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 3577293158" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
